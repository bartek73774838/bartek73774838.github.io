<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ascend English â€” B1 â†’ C1</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=IBM+Plex+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0d0d0d;
  --surface: #161616;
  --surface2: #1f1f1f;
  --border: #2a2a2a;
  --accent: #c8a96e;
  --accent2: #7eb8d4;
  --accent3: #b87e7e;
  --text: #e8e4dc;
  --text2: #9a9590;
  --text3: #5a5650;
  --success: #6dbf8a;
  --error: #d97474;
  --warning: #d4a853;
  --radius: 4px;
}

- { box-sizing: border-box; margin: 0; padding: 0; }

body {
font-family: â€˜DM Sansâ€™, sans-serif;
background: var(â€“bg);
color: var(â€“text);
min-height: 100vh;
font-size: 15px;
line-height: 1.6;
}

/* LAYOUT */
.app { display: flex; min-height: 100vh; }

.sidebar {
width: 220px;
min-height: 100vh;
background: var(â€“surface);
border-right: 1px solid var(â€“border);
display: flex;
flex-direction: column;
position: fixed;
top: 0; left: 0; bottom: 0;
z-index: 100;
transition: transform 0.3s ease;
}

.sidebar-logo {
padding: 28px 20px 20px;
border-bottom: 1px solid var(â€“border);
}

.sidebar-logo .brand {
font-family: â€˜Playfair Displayâ€™, serif;
font-size: 20px;
color: var(â€“accent);
letter-spacing: 0.02em;
}

.sidebar-logo .tagline {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 10px;
color: var(â€“text3);
letter-spacing: 0.15em;
text-transform: uppercase;
margin-top: 4px;
}

.sidebar-streak {
padding: 14px 20px;
border-bottom: 1px solid var(â€“border);
display: flex;
align-items: center;
gap: 10px;
}

.streak-flame {
font-size: 20px;
}

.streak-info .label {
font-size: 10px;
color: var(â€“text3);
text-transform: uppercase;
letter-spacing: 0.1em;
}

.streak-info .count {
font-size: 22px;
font-weight: 700;
color: var(â€“accent);
line-height: 1;
}

.sidebar-nav {
flex: 1;
padding: 12px 0;
overflow-y: auto;
}

.nav-item {
display: flex;
align-items: center;
gap: 10px;
padding: 10px 20px;
cursor: pointer;
color: var(â€“text2);
font-size: 13.5px;
font-weight: 400;
border-left: 3px solid transparent;
transition: all 0.15s;
user-select: none;
}

.nav-item:hover { color: var(â€“text); background: var(â€“surface2); }

.nav-item.active {
color: var(â€“accent);
border-left-color: var(â€“accent);
background: rgba(200, 169, 110, 0.06);
}

.nav-icon { font-size: 16px; width: 20px; text-align: center; }
.nav-label { flex: 1; }
.nav-badge {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 10px;
background: var(â€“accent);
color: var(â€“bg);
border-radius: 10px;
padding: 1px 7px;
font-weight: 500;
}

.sidebar-level {
padding: 14px 20px;
border-top: 1px solid var(â€“border);
}

.level-label {
font-size: 10px;
color: var(â€“text3);
text-transform: uppercase;
letter-spacing: 0.1em;
margin-bottom: 6px;
}

.level-bar {
height: 3px;
background: var(â€“border);
border-radius: 2px;
overflow: hidden;
}

.level-fill {
height: 100%;
background: linear-gradient(90deg, var(â€“accent), var(â€“accent2));
border-radius: 2px;
transition: width 0.5s ease;
}

.level-range {
display: flex;
justify-content: space-between;
margin-top: 5px;
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 10px;
color: var(â€“text3);
}

/* MAIN CONTENT */
.main {
margin-left: 220px;
flex: 1;
min-height: 100vh;
}

.top-bar {
height: 56px;
border-bottom: 1px solid var(â€“border);
display: flex;
align-items: center;
padding: 0 32px;
gap: 16px;
position: sticky;
top: 0;
background: var(â€“bg);
z-index: 50;
}

.top-bar-title {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 11px;
text-transform: uppercase;
letter-spacing: 0.15em;
color: var(â€“text3);
flex: 1;
}

.top-bar-date {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 11px;
color: var(â€“text3);
}

.content-area {
padding: 36px 40px;
max-width: 860px;
}

/* VIEWS */
.view { display: none; }
.view.active { display: block; }

/* CARDS */
.card {
background: var(â€“surface);
border: 1px solid var(â€“border);
border-radius: var(â€“radius);
padding: 24px;
margin-bottom: 20px;
}

.card-header {
display: flex;
align-items: flex-start;
justify-content: space-between;
margin-bottom: 18px;
gap: 12px;
}

.card-title {
font-family: â€˜Playfair Displayâ€™, serif;
font-size: 18px;
color: var(â€“text);
line-height: 1.3;
}

.card-subtitle {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 10px;
color: var(â€“text3);
text-transform: uppercase;
letter-spacing: 0.12em;
margin-top: 3px;
}

.section-label {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 10px;
text-transform: uppercase;
letter-spacing: 0.15em;
color: var(â€“text3);
margin-bottom: 14px;
padding-bottom: 8px;
border-bottom: 1px solid var(â€“border);
}

/* VOCABULARY CARD */
.word-display {
text-align: center;
padding: 24px 0 20px;
}

.word-main {
font-family: â€˜Playfair Displayâ€™, serif;
font-size: 38px;
color: var(â€“accent);
letter-spacing: -0.01em;
}

.word-phonetic {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 13px;
color: var(â€“text3);
margin-top: 4px;
}

.word-pos {
display: inline-block;
font-size: 11px;
font-family: â€˜IBM Plex Monoâ€™, monospace;
background: var(â€“surface2);
border: 1px solid var(â€“border);
padding: 2px 10px;
border-radius: 20px;
color: var(â€“text2);
margin-top: 10px;
letter-spacing: 0.05em;
}

.word-definition {
font-size: 15px;
color: var(â€“text);
line-height: 1.7;
margin: 16px 0;
padding: 14px 18px;
background: var(â€“surface2);
border-left: 3px solid var(â€“accent);
border-radius: 0 var(â€“radius) var(â€“radius) 0;
}

.word-examples {
margin: 14px 0;
}

.example-item {
font-size: 14px;
color: var(â€“text2);
padding: 8px 0;
border-bottom: 1px solid var(â€“border);
line-height: 1.6;
font-style: italic;
}

.example-item:last-child { border-bottom: none; }

.word-meta {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 12px;
margin-top: 16px;
}

.meta-box {
background: var(â€“surface2);
border: 1px solid var(â€“border);
border-radius: var(â€“radius);
padding: 12px 14px;
}

.meta-box-label {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 9px;
text-transform: uppercase;
letter-spacing: 0.12em;
color: var(â€“text3);
margin-bottom: 6px;
}

.meta-box-content {
font-size: 13px;
color: var(â€“text2);
line-height: 1.5;
}

.meta-box-content .tag {
display: inline-block;
background: var(â€“border);
padding: 2px 8px;
border-radius: 3px;
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 11px;
color: var(â€“text2);
margin: 2px 2px 2px 0;
}

.error-highlight {
color: var(â€“error);
font-style: italic;
}

.word-actions {
display: flex;
gap: 10px;
margin-top: 18px;
flex-wrap: wrap;
}

.reveal-translation {
background: var(â€“surface2);
border: 1px solid var(â€“accent);
border-radius: var(â€“radius);
padding: 12px 16px;
margin-top: 14px;
cursor: pointer;
text-align: center;
color: var(â€“accent);
font-size: 13px;
transition: all 0.2s;
font-family: â€˜IBM Plex Monoâ€™, monospace;
letter-spacing: 0.05em;
}

.reveal-translation:hover { background: rgba(200,169,110,0.1); }

.translation-content {
font-size: 18px;
color: var(â€“accent);
font-family: â€˜Playfair Displayâ€™, serif;
padding: 8px 0 4px;
}

.translation-hidden {
filter: blur(8px);
user-select: none;
transition: filter 0.3s;
}

.translation-hidden.revealed { filter: none; }

/* BUTTONS */
.btn {
display: inline-flex;
align-items: center;
gap: 6px;
padding: 9px 18px;
border-radius: var(â€“radius);
font-size: 13px;
font-family: â€˜DM Sansâ€™, sans-serif;
font-weight: 500;
cursor: pointer;
border: 1px solid transparent;
transition: all 0.15s;
text-decoration: none;
user-select: none;
}

.btn-primary {
background: var(â€“accent);
color: var(â€“bg);
border-color: var(â€“accent);
}

.btn-primary:hover { background: #d4b87a; }

.btn-ghost {
background: transparent;
color: var(â€“text2);
border-color: var(â€“border);
}

.btn-ghost:hover { border-color: var(â€“text2); color: var(â€“text); }

.btn-accent2 {
background: rgba(126,184,212,0.1);
color: var(â€“accent2);
border-color: rgba(126,184,212,0.3);
}

.btn-accent2:hover { background: rgba(126,184,212,0.2); }

.btn-sm {
padding: 6px 12px;
font-size: 12px;
}

.btn-icon {
padding: 8px;
border-radius: var(â€“radius);
background: var(â€“surface2);
border: 1px solid var(â€“border);
cursor: pointer;
font-size: 16px;
transition: all 0.15s;
color: var(â€“text2);
}

.btn-icon:hover { border-color: var(â€“text2); color: var(â€“text); }

/* WORD NAVIGATION */
.word-nav {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 20px;
}

.word-counter {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 12px;
color: var(â€“text3);
}

.word-dots {
display: flex;
gap: 5px;
}

.word-dot {
width: 6px;
height: 6px;
border-radius: 50%;
background: var(â€“border);
transition: background 0.2s;
}

.word-dot.active { background: var(â€“accent); }
.word-dot.done { background: var(â€“success); }

/* EXERCISES */
.exercise-block {
background: var(â€“surface2);
border: 1px solid var(â€“border);
border-radius: var(â€“radius);
padding: 20px;
margin-bottom: 14px;
}

.exercise-type {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 9px;
text-transform: uppercase;
letter-spacing: 0.15em;
color: var(â€“accent);
margin-bottom: 10px;
}

.exercise-prompt {
font-size: 15px;
color: var(â€“text);
line-height: 1.7;
margin-bottom: 14px;
}

.exercise-prompt .blank {
display: inline-block;
min-width: 100px;
border-bottom: 2px solid var(â€“accent);
margin: 0 4px;
}

.answer-input {
width: 100%;
background: var(â€“surface);
border: 1px solid var(â€“border);
border-radius: var(â€“radius);
padding: 10px 14px;
color: var(â€“text);
font-size: 14px;
font-family: â€˜DM Sansâ€™, sans-serif;
outline: none;
transition: border-color 0.2s;
}

.answer-input:focus { border-color: var(â€“accent); }
.answer-input.correct { border-color: var(â€“success); background: rgba(109,191,138,0.05); }
.answer-input.incorrect { border-color: var(â€“error); background: rgba(217,116,116,0.05); }

.answer-feedback {
margin-top: 10px;
padding: 10px 14px;
border-radius: var(â€“radius);
font-size: 13px;
display: none;
}

.answer-feedback.show { display: block; }
.answer-feedback.success { background: rgba(109,191,138,0.1); border: 1px solid rgba(109,191,138,0.3); color: var(â€“success); }
.answer-feedback.failure { background: rgba(217,116,116,0.1); border: 1px solid rgba(217,116,116,0.3); color: var(â€“error); }

.check-btn {
margin-top: 12px;
}

/* GRAMMAR */
.grammar-rule {
font-size: 14.5px;
line-height: 1.8;
color: var(â€“text);
margin-bottom: 20px;
}

.grammar-rule h4 {
font-family: â€˜Playfair Displayâ€™, serif;
font-size: 17px;
color: var(â€“accent);
margin: 18px 0 8px;
}

.grammar-rule .formula {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 13px;
background: var(â€“surface2);
border: 1px solid var(â€“border);
border-left: 3px solid var(â€“accent2);
padding: 10px 16px;
border-radius: 0 var(â€“radius) var(â€“radius) 0;
margin: 12px 0;
color: var(â€“accent2);
}

.grammar-rule .example-en {
color: var(â€“accent);
font-style: italic;
}

.grammar-rule .example-fr {
color: var(â€“text3);
font-size: 13px;
}

.grammar-rule .warning {
background: rgba(212,168,83,0.1);
border: 1px solid rgba(212,168,83,0.3);
border-radius: var(â€“radius);
padding: 12px 16px;
margin: 14px 0;
color: var(â€“warning);
font-size: 13.5px;
}

.grammar-rule .warning::before { content: â€œâš  â€œ; }

.grammar-rule .exception {
background: rgba(184,126,126,0.08);
border: 1px solid rgba(184,126,126,0.25);
border-radius: var(â€“radius);
padding: 12px 16px;
margin: 10px 0;
color: var(â€“accent3);
font-size: 13.5px;
}

/* PROGRESS */
.stats-grid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 14px;
margin-bottom: 24px;
}

.stat-card {
background: var(â€“surface);
border: 1px solid var(â€“border);
border-radius: var(â€“radius);
padding: 18px;
text-align: center;
}

.stat-value {
font-family: â€˜Playfair Displayâ€™, serif;
font-size: 36px;
color: var(â€“accent);
line-height: 1;
}

.stat-label {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 10px;
text-transform: uppercase;
letter-spacing: 0.1em;
color: var(â€“text3);
margin-top: 6px;
}

.progress-week {
display: flex;
gap: 6px;
margin: 18px 0;
}

.day-block {
flex: 1;
height: 60px;
border-radius: var(â€“radius);
background: var(â€“surface2);
border: 1px solid var(â€“border);
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
gap: 4px;
transition: all 0.2s;
}

.day-block.done {
background: rgba(109,191,138,0.1);
border-color: rgba(109,191,138,0.3);
}

.day-block.today {
border-color: var(â€“accent);
}

.day-label {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 9px;
text-transform: uppercase;
color: var(â€“text3);
letter-spacing: 0.08em;
}

.day-check {
font-size: 16px;
}

/* VOCABULARY BANK */
.vocab-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 10px;
}

.vocab-item {
background: var(â€“surface2);
border: 1px solid var(â€“border);
border-radius: var(â€“radius);
padding: 14px;
cursor: pointer;
transition: border-color 0.15s;
}

.vocab-item:hover { border-color: var(â€“text2); }

.vocab-word {
font-family: â€˜Playfair Displayâ€™, serif;
font-size: 17px;
color: var(â€“accent);
}

.vocab-pos {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 10px;
color: var(â€“text3);
text-transform: uppercase;
}

.vocab-def {
font-size: 12px;
color: var(â€“text2);
margin-top: 6px;
line-height: 1.5;
}

.vocab-lesson {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 10px;
color: var(â€“text3);
margin-top: 8px;
}

/* ERROR LOG */
.error-entry {
background: var(â€“surface2);
border: 1px solid rgba(217,116,116,0.2);
border-radius: var(â€“radius);
padding: 14px 16px;
margin-bottom: 10px;
}

.error-entry-word {
font-family: â€˜Playfair Displayâ€™, serif;
font-size: 16px;
color: var(â€“accent);
margin-bottom: 4px;
}

.error-entry-detail {
font-size: 13px;
color: var(â€“text3);
}

.error-entry-count {
float: right;
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 11px;
background: rgba(217,116,116,0.15);
color: var(â€“error);
padding: 2px 8px;
border-radius: 10px;
}

/* WEEKLY TEST */
.test-question {
background: var(â€“surface2);
border: 1px solid var(â€“border);
border-radius: var(â€“radius);
padding: 20px;
margin-bottom: 16px;
}

.test-q-num {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 10px;
color: var(â€“text3);
text-transform: uppercase;
letter-spacing: 0.1em;
margin-bottom: 10px;
}

.test-q-text {
font-size: 15px;
color: var(â€“text);
margin-bottom: 14px;
line-height: 1.6;
}

.test-options {
display: grid;
gap: 8px;
}

.test-option {
padding: 10px 14px;
border: 1px solid var(â€“border);
border-radius: var(â€“radius);
cursor: pointer;
font-size: 14px;
color: var(â€“text2);
transition: all 0.15s;
}

.test-option:hover { border-color: var(â€“accent); color: var(â€“text); }
.test-option.selected { border-color: var(â€“accent); color: var(â€“accent); background: rgba(200,169,110,0.06); }
.test-option.correct { border-color: var(â€“success); color: var(â€“success); background: rgba(109,191,138,0.06); }
.test-option.wrong { border-color: var(â€“error); color: var(â€“error); background: rgba(217,116,116,0.06); }

/* LESSON PHASES */
.phase-indicator {
display: flex;
gap: 8px;
margin-bottom: 28px;
align-items: center;
}

.phase-step {
display: flex;
align-items: center;
gap: 6px;
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 10px;
text-transform: uppercase;
letter-spacing: 0.1em;
color: var(â€“text3);
}

.phase-step.active { color: var(â€“accent); }
.phase-step.done { color: var(â€“success); }

.phase-dot {
width: 8px;
height: 8px;
border-radius: 50%;
background: var(â€“border);
}

.phase-step.active .phase-dot { background: var(â€“accent); }
.phase-step.done .phase-dot { background: var(â€“success); }

.phase-line {
flex: 1;
height: 1px;
background: var(â€“border);
}

/* COMPLETE STATE */
.lesson-complete {
text-align: center;
padding: 60px 20px;
}

.lesson-complete-icon {
font-size: 60px;
margin-bottom: 20px;
}

.lesson-complete-title {
font-family: â€˜Playfair Displayâ€™, serif;
font-size: 32px;
color: var(â€“accent);
margin-bottom: 12px;
}

.lesson-complete-text {
font-size: 15px;
color: var(â€“text2);
margin-bottom: 30px;
}

/* TAGS */
.tag {
display: inline-block;
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 10px;
padding: 2px 8px;
border-radius: 3px;
border: 1px solid var(â€“border);
color: var(â€“text3);
margin-right: 4px;
}

.tag-formal { border-color: rgba(126,184,212,0.4); color: var(â€“accent2); }
.tag-informal { border-color: rgba(109,191,138,0.4); color: var(â€“success); }
.tag-academic { border-color: rgba(200,169,110,0.4); color: var(â€“accent); }
.tag-colloquial { border-color: rgba(184,126,126,0.4); color: var(â€“accent3); }

/* SCROLLBAR */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(â€“bg); }
::-webkit-scrollbar-thumb { background: var(â€“border); border-radius: 3px; }

/* DIVIDER */
.divider {
border: none;
border-top: 1px solid var(â€“border);
margin: 24px 0;
}

/* EMPTY STATE */
.empty-state {
text-align: center;
padding: 60px 20px;
color: var(â€“text3);
}

.empty-state-icon { font-size: 40px; margin-bottom: 14px; }
.empty-state-text { font-size: 15px; }

/* MOBILE MENU */
.mobile-toggle {
display: none;
position: fixed;
top: 12px;
left: 12px;
z-index: 200;
background: var(â€“surface);
border: 1px solid var(â€“border);
border-radius: var(â€“radius);
padding: 8px 12px;
cursor: pointer;
font-size: 18px;
color: var(â€“text2);
}

@media (max-width: 768px) {
.sidebar { transform: translateX(-100%); }
.sidebar.open { transform: none; }
.mobile-toggle { display: block; }
.main { margin-left: 0; }
.content-area { padding: 24px 20px; }
.stats-grid { grid-template-columns: 1fr 1fr; }
.vocab-grid { grid-template-columns: 1fr; }
.word-meta { grid-template-columns: 1fr; }
}

/* ANIMATIONS */
@keyframes fadeIn {
from { opacity: 0; transform: translateY(8px); }
to { opacity: 1; transform: translateY(0); }
}

.card { animation: fadeIn 0.3s ease; }

/* AI GENERATION */
@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.4; }
}

@keyframes spin {
to { transform: rotate(360deg); }
}

.ai-loading {
text-align: center;
padding: 80px 20px;
}

.ai-loading-spinner {
width: 40px;
height: 40px;
border: 2px solid var(â€“border);
border-top-color: var(â€“accent);
border-radius: 50%;
animation: spin 0.8s linear infinite;
margin: 0 auto 24px;
}

.ai-loading-title {
font-family: â€˜Playfair Displayâ€™, serif;
font-size: 22px;
color: var(â€“accent);
margin-bottom: 10px;
}

.ai-loading-steps {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 11px;
color: var(â€“text3);
text-transform: uppercase;
letter-spacing: 0.12em;
animation: pulse 1.5s ease infinite;
}

.ai-badge {
display: inline-flex;
align-items: center;
gap: 5px;
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 9px;
text-transform: uppercase;
letter-spacing: 0.12em;
color: var(â€“accent2);
border: 1px solid rgba(126,184,212,0.3);
padding: 2px 8px;
border-radius: 10px;
background: rgba(126,184,212,0.06);
}

.ai-error-box {
background: rgba(217,116,116,0.08);
border: 1px solid rgba(217,116,116,0.25);
border-radius: var(â€“radius);
padding: 20px 24px;
margin: 20px 0;
}

.ai-error-title {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 11px;
text-transform: uppercase;
letter-spacing: 0.1em;
color: var(â€“error);
margin-bottom: 8px;
}

.ai-error-msg {
font-size: 13px;
color: var(â€“text2);
line-height: 1.6;
}

.stream-cursor {
display: inline-block;
width: 2px;
height: 1em;
background: var(â€“accent);
vertical-align: middle;
animation: pulse 0.8s ease infinite;
margin-left: 2px;
}

/* GRAMMAR ARCHIVE */
.grammar-archive-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 14px 16px;
border: 1px solid var(â€“border);
border-radius: var(â€“radius);
margin-bottom: 8px;
background: var(â€“surface2);
cursor: pointer;
transition: border-color 0.15s;
}

.grammar-archive-item:hover { border-color: var(â€“text2); }

.grammar-archive-topic {
font-size: 14.5px;
color: var(â€“text);
}

.grammar-archive-lesson {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 10px;
color: var(â€“text3);
margin-top: 2px;
}

.grammar-archive-level {
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 10px;
padding: 3px 10px;
border-radius: 10px;
background: var(â€“border);
color: var(â€“text2);
}
</style>

</head>
<body>

<button class="mobile-toggle" onclick="toggleSidebar()">â˜°</button>

<div class="app">
  <!-- SIDEBAR -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="brand">Ascend</div>
      <div class="tagline">English B1 â†’ C1</div>
    </div>

```
<div class="sidebar-streak">
  <span class="streak-flame">ğŸ”¥</span>
  <div class="streak-info">
    <div class="label">Day streak</div>
    <div class="count" id="streak-count">0</div>
  </div>
</div>

<div class="sidebar-nav">
  <div class="nav-item active" data-view="lesson" onclick="showView('lesson')">
    <span class="nav-icon">ğŸ“–</span>
    <span class="nav-label">Today's Lesson</span>
    <span class="nav-badge" id="lesson-badge" style="display:none">!</span>
  </div>
  <div class="nav-item" data-view="test" onclick="showView('test')">
    <span class="nav-icon">ğŸ“</span>
    <span class="nav-label">Weekly Test</span>
    <span class="nav-badge" id="test-badge" style="display:none">!</span>
  </div>
  <div class="nav-item" data-view="progress" onclick="showView('progress')">
    <span class="nav-icon">ğŸ“Š</span>
    <span class="nav-label">Progress</span>
  </div>
  <div class="nav-item" data-view="errors" onclick="showView('errors')">
    <span class="nav-icon">âš¡</span>
    <span class="nav-label">Error Log</span>
  </div>
  <div class="nav-item" data-view="vocab" onclick="showView('vocab')">
    <span class="nav-icon">ğŸ“š</span>
    <span class="nav-label">Vocabulary Bank</span>
  </div>
  <div class="nav-item" data-view="grammar" onclick="showView('grammar')">
    <span class="nav-icon">âš™</span>
    <span class="nav-label">Grammar Archive</span>
  </div>
</div>

<div class="sidebar-level">
  <div class="level-label">Current level</div>
  <div class="level-bar">
    <div class="level-fill" id="level-fill" style="width: 5%"></div>
  </div>
  <div class="level-range">
    <span>B1</span>
    <span id="level-label-text">B1+</span>
    <span>C1</span>
  </div>
</div>
```

  </nav>

  <!-- MAIN -->

  <main class="main">
    <div class="top-bar">
      <div class="top-bar-title" id="view-title">Today's Lesson</div>
      <div class="top-bar-date" id="top-date"></div>
    </div>

```
<div class="content-area">

  <!-- LESSON VIEW -->
  <div class="view active" id="view-lesson">
    <div id="lesson-container"></div>
  </div>

  <!-- TEST VIEW -->
  <div class="view" id="view-test">
    <div id="test-container"></div>
  </div>

  <!-- PROGRESS VIEW -->
  <div class="view" id="view-progress">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="stat-lessons">0</div>
        <div class="stat-label">Lessons done</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-words">0</div>
        <div class="stat-label">Words learned</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-accuracy">â€“</div>
        <div class="stat-label">Accuracy</div>
      </div>
    </div>

    <div class="card">
      <div class="section-label">This week</div>
      <div class="progress-week" id="week-grid"></div>
    </div>

    <div class="card">
      <div class="section-label">Test history</div>
      <div id="test-history-list"></div>
    </div>

    <div class="card">
      <div class="section-label">Module progress</div>
      <div id="module-progress"></div>
    </div>
  </div>

  <!-- ERRORS VIEW -->
  <div class="view" id="view-errors">
    <div id="error-list-container"></div>
  </div>

  <!-- VOCABULARY BANK -->
  <div class="view" id="view-vocab">
    <div class="card" style="margin-bottom: 16px;">
      <input class="answer-input" id="vocab-search" placeholder="Search wordsâ€¦" oninput="renderVocabBank()">
    </div>
    <div class="vocab-grid" id="vocab-grid"></div>
  </div>

  <!-- GRAMMAR ARCHIVE -->
  <div class="view" id="view-grammar">
    <div id="grammar-archive-list"></div>
  </div>

</div>
```

  </main>
</div>

<script>
// ============================================================
// DATA â€” CURRICULUM (10 lessons built-in)
// ============================================================
const CURRICULUM = [
  // LESSON 1
  {
    id: 1,
    module: "Everyday UK English",
    level: "B1+",
    vocabulary: [
      {
        word: "intricate", phonetic: "/ËˆÉªntrÉªkÉªt/", pos: "adjective",
        definition: "Having many small parts or details that are closely related or connected; very complicated.",
        examples: [
          "The jeweller crafted an intricate gold necklace with dozens of tiny leaves.",
          "The plot of the novel was so intricate that I had to reread several chapters."
        ],
        collocations: ["intricate details", "intricate design", "intricate pattern", "intricate web of"],
        register: "formal",
        frenchError: "French speakers often say 'complex' where 'intricate' is more precise â€” 'intricate' implies fine detail, not just difficulty.",
        fr: "complexe / Ã©laborÃ© / minutieux"
      },
      {
        word: "reckon", phonetic: "/ËˆrekÉ™n/", pos: "verb",
        definition: "(Informal, UK) To think, believe, or consider something to be true.",
        examples: [
          "I reckon we'll need at least two hours to get there.",
          "She reckons he's lying, but I'm not so sure."
        ],
        collocations: ["I reckon", "reckon on doing", "reckon with", "to be reckoned with"],
        register: "informal / colloquial UK",
        frenchError: "French speakers often translate 'je pense' as 'I think' â€” in UK English, 'I reckon' sounds more natural in casual speech.",
        fr: "je pense / je crois / estimer"
      },
      {
        word: "albeit", phonetic: "/É”ËlËˆbiËÉªt/", pos: "conjunction",
        definition: "Although; even though â€” used to introduce a concessive clause.",
        examples: [
          "The results were encouraging, albeit not entirely conclusive.",
          "He accepted the offer, albeit reluctantly."
        ],
        collocations: ["albeit slowly", "albeit briefly", "albeit somewhat", "albeit imperfect"],
        register: "formal / written",
        frenchError: "French speakers tend to use 'even if' or 'though' â€” 'albeit' is more concise and formal, common in written English.",
        fr: "bien que / quoique / mÃªme si"
      },
      {
        word: "keen", phonetic: "/kiËn/", pos: "adjective",
        definition: "Very interested in or enthusiastic about something; eager. Also: sharp (blade, mind).",
        examples: [
          "She's a keen runner who trains every morning before work.",
          "He wasn't particularly keen on the idea of moving abroad."
        ],
        collocations: ["keen on", "keen interest", "keen supporter", "not keen on"],
        register: "informal to neutral, very common in UK English",
        frenchError: "French speakers say 'j'aime bien' â€” in UK English 'I'm quite keen on it' expresses similar moderate enthusiasm more naturally.",
        fr: "enthousiaste / passionnÃ© / intÃ©ressÃ© par"
      },
      {
        word: "forthcoming", phonetic: "/fÉ”ËÎ¸ËˆkÊŒmÉªÅ‹/", pos: "adjective",
        definition: "1. About to happen or appear in the near future. 2. Willing to give information; open.",
        examples: [
          "Details of the forthcoming changes will be announced next week.",
          "The witness was not very forthcoming about what he had seen."
        ],
        collocations: ["forthcoming album", "forthcoming election", "be forthcoming with", "not forthcoming"],
        register: "formal to neutral",
        frenchError: "French speakers may say 'future' for the first meaning â€” 'forthcoming' implies imminence, not just future.",
        fr: "prochain / imminent / communicatif"
      },
      {
        word: "mundane", phonetic: "/mÊŒnËˆdeÉªn/", pos: "adjective",
        definition: "Lacking interest or excitement; dull and ordinary; relating to ordinary daily life.",
        examples: [
          "He found the mundane tasks of office life increasingly frustrating.",
          "Even the most mundane objects can become fascinating when examined closely."
        ],
        collocations: ["mundane tasks", "mundane life", "mundane details", "mundane reality"],
        register: "neutral to slightly literary",
        frenchError: "French speakers use 'banal' â€” while both work, 'mundane' also carries the sense of earthly vs. divine, giving it depth.",
        fr: "banal / ordinaire / terre-Ã -terre"
      },
      {
        word: "undermine", phonetic: "/ËŒÊŒndÉ™ËˆmaÉªn/", pos: "verb",
        definition: "To gradually weaken or damage something, especially someone's authority, confidence, or a plan.",
        examples: [
          "His constant criticism began to undermine her confidence.",
          "These revelations could seriously undermine the government's authority."
        ],
        collocations: ["undermine confidence", "undermine authority", "undermine efforts", "undermine trust"],
        register: "neutral to formal",
        frenchError: "French speakers often use 'affaiblir' â€” 'undermine' is more metaphorical, suggesting erosion from within or below.",
        fr: "saper / miner / affaiblir"
      },
      {
        word: "substantial", phonetic: "/sÉ™bËˆstÃ¦nÊƒl/", pos: "adjective",
        definition: "Of considerable importance, size, or worth; large in amount.",
        examples: [
          "The project required a substantial amount of funding.",
          "There is substantial evidence to support this claim."
        ],
        collocations: ["substantial evidence", "substantial amount", "substantial progress", "substantial difference"],
        register: "formal to neutral",
        frenchError: "French speakers may use 'important' â€” in English, 'important' means significant, not large. Use 'substantial' or 'considerable' for size.",
        fr: "considÃ©rable / important / substantiel"
      },
      {
        word: "candid", phonetic: "/ËˆkÃ¦ndÉªd/", pos: "adjective",
        definition: "Truthful and straightforward; not hiding one's thoughts or feelings; frank.",
        examples: [
          "I appreciated her candid assessment of my work.",
          "To be candid, I think the project is unlikely to succeed."
        ],
        collocations: ["candid assessment", "candid interview", "be candid about", "candid opinion"],
        register: "formal to neutral",
        frenchError: "French speakers say 'franc' or 'honnÃªte' â€” 'candid' implies directness without harshness, a nuance that 'franc' doesn't always capture.",
        fr: "franc / sincÃ¨re / direct"
      },
      {
        word: "grasp", phonetic: "/É¡rÉ‘Ësp/", pos: "verb / noun",
        definition: "To understand something fully (verb); understanding or comprehension (noun); also to grip firmly.",
        examples: [
          "It took him a while to fully grasp the implications of the decision.",
          "She has an impressive grasp of the technical details."
        ],
        collocations: ["grasp an idea", "firm grasp", "grasp the concept", "within one's grasp"],
        register: "neutral",
        frenchError: "French speakers often use 'comprendre' â€” 'grasp' implies effort and full comprehension, suggesting the idea was initially elusive.",
        fr: "saisir / comprendre / maÃ®trise"
      }
    ],
    grammar: {
      topic: "Present Perfect vs. Simple Past â€” Key Distinctions",
      level: "B1+",
      explanation: `<h4>The Core Rule</h4>
<p>The <strong>Present Perfect</strong> connects a past event to the present. The <strong>Simple Past</strong> describes a completed event with no connection to now.</p>
<div class="formula">Subject + have/has + past participle â†’ Present Perfect<br>Subject + V2 â†’ Simple Past</div>
<h4>When to Use Present Perfect</h4>
<p>âœ¦ Experiences in your life (time unspecified): <span class="example-en">"I've visited Tokyo."</span><br>
âœ¦ Recent events with present relevance: <span class="example-en">"She's just left."</span><br>
âœ¦ With: ever, never, already, yet, just, still, recently, so far, up to now.<br>
âœ¦ Unfinished periods: <span class="example-en">"I've lived here for five years."</span> (still living)</p>
<h4>When to Use Simple Past</h4>
<p>âœ¦ Completed action at a specific time: <span class="example-en">"I went to Tokyo in 2019."</span><br>
âœ¦ With: yesterday, last week, ago, in 2010, when I was young.<br>
âœ¦ Sequence of past events: <span class="example-en">"She entered, sat down, and opened her laptop."</span></p>
<div class="warning">French interference: French speakers often use "passÃ© composÃ©" for both â€” in UK English, using Simple Past in "Have you eaten yet?" (instead of Present Perfect) sounds American or wrong.</div>
<h4>Tricky Cases</h4>
<p>âœ¦ <span class="example-en">"Did you see the news?" (implies specific event, maybe today)</span> vs <span class="example-en">"Have you seen the news?"</span> (open time frame)<br>
âœ¦ "For" + Present Perfect = ongoing. "For" + Simple Past = finished: <span class="example-en">"I worked there for a year."</span> (no longer there)</p>
<div class="exception">British vs American: British English prefers "I've just eaten" â€” American English often uses "I just ate". Both correct in their contexts.</div>`,
      exercises: [
        {
          type: "Error Correction",
          prompt: "Correct the error: \"I already finished the report, so you can read it now.\"",
          answer: "I have already finished the report, so you can read it now.",
          explanation: "\"already\" with a result in the present â†’ Present Perfect required"
        },
        {
          type: "Sentence Transformation",
          prompt: "Transform using the word given: \"My sister started learning piano three years ago and she still plays.\" (FOR)",
          answer: "My sister has been learning / has played piano for three years.",
          explanation: "Unfinished period = Present Perfect with 'for'"
        },
        {
          type: "Gap Fill",
          prompt: "Complete: \"When I arrived at the party, everyone ______ (already / leave).\"",
          answer: "had already left",
          explanation: "Past Perfect for an action completed before another past event"
        },
        {
          type: "Translation",
          prompt: "Translate: \"Il vient d'appeler â€” tu l'as manquÃ©.\"",
          answer: "He has just called â€” you've just missed him.",
          explanation: "Recent past with present relevance = Present Perfect + 'just'"
        }
      ]
    }
  },

  // LESSON 2
  {
    id: 2,
    module: "Intermediate Consolidation",
    level: "B1+",
    vocabulary: [
      {
        word: "shrewd", phonetic: "/ÊƒruËd/", pos: "adjective",
        definition: "Having sharp powers of judgement; clever at understanding and profiting from situations.",
        examples: [
          "A shrewd investor, she bought property just before prices rose.",
          "His shrewd observations about human nature made him a gifted novelist."
        ],
        collocations: ["shrewd businessman", "shrewd move", "shrewd observer", "politically shrewd"],
        register: "neutral to slightly formal",
        frenchError: "French speakers say 'intelligent' or 'malin' â€” 'shrewd' specifically implies practical cleverness and good judgement, especially in financial or social contexts.",
        fr: "astucieux / perspicace / malin"
      },
      {
        word: "alleviate", phonetic: "/É™ËˆliËvieÉªt/", pos: "verb",
        definition: "To make suffering, pain, or a problem less severe.",
        examples: [
          "The medication helped to alleviate her symptoms.",
          "Several measures were introduced to alleviate poverty in the region."
        ],
        collocations: ["alleviate pain", "alleviate suffering", "alleviate concerns", "alleviate pressure"],
        register: "formal",
        frenchError: "French speakers use 'soulager' or 'attÃ©nuer' â€” both map well, but 'alleviate' is slightly more formal and common in written English.",
        fr: "attÃ©nuer / soulager / allÃ©ger"
      },
      {
        word: "blunt", phonetic: "/blÊŒnt/", pos: "adjective",
        definition: "Saying things in a direct, honest way without caring about feelings; also: not sharp (blade).",
        examples: [
          "She gave him a blunt assessment of his chances of success.",
          "To be blunt, the presentation was poorly prepared."
        ],
        collocations: ["blunt honesty", "to be blunt", "blunt criticism", "bluntly speaking"],
        register: "neutral to informal",
        frenchError: "French speakers may hesitate between 'direct' and 'brutal' â€” 'blunt' falls between: honest and direct, but not unkind.",
        fr: "direct / brusque / franc du collier"
      },
      {
        word: "overlook", phonetic: "/ËŒoÊŠvÉ™rËˆlÊŠk/", pos: "verb",
        definition: "1. To fail to notice or consider something. 2. To deliberately ignore something. 3. To have a view over.",
        examples: [
          "It's easy to overlook the importance of sleep when you're busy.",
          "The hotel room overlooked a beautiful garden."
        ],
        collocations: ["overlook a mistake", "overlook the sea", "easy to overlook", "be overlooked"],
        register: "neutral",
        frenchError: "French speakers confuse 'overlook' with 'supervise' (it means the opposite). 'To overlook' = to miss or ignore, not to watch over.",
        fr: "nÃ©gliger / ignorer / passer sous silence / dominer (vue)"
      },
      {
        word: "articulate", phonetic: "/É‘ËËˆtÉªkjÊŠlÉªt/", pos: "adjective / verb",
        definition: "Adjective: able to express ideas clearly and fluently. Verb: to express thoughts in words.",
        examples: [
          "She gave an articulate and compelling argument.",
          "He struggled to articulate exactly what he felt."
        ],
        collocations: ["well-articulated", "clearly articulate", "articulate a view", "articulate speaker"],
        register: "formal to neutral",
        frenchError: "French speakers use 'articuler' in French, but in English the adjective 'articulate' specifically describes communication skill, not pronunciation.",
        fr: "Ã©loquent / bien s'exprimer / articuler"
      },
      {
        word: "persevere", phonetic: "/ËŒpÉœËsÉªËˆvÉªÉ™/", pos: "verb",
        definition: "To continue trying to do something despite difficulties.",
        examples: [
          "Despite early failures, she persevered and eventually succeeded.",
          "You need to persevere with the exercises even when they feel difficult."
        ],
        collocations: ["persevere with", "persevere despite", "persevere in the face of", "continue to persevere"],
        register: "neutral to slightly formal",
        frenchError: "French speakers use 'persÃ©vÃ©rer' â€” cognate, but note the preposition: 'persevere WITH something', not 'persevere ON something'.",
        fr: "persÃ©vÃ©rer / s'acharner / ne pas abandonner"
      },
      {
        word: "subtle", phonetic: "/ËˆsÊŒtl/", pos: "adjective",
        definition: "Not immediately obvious or noticeable; clever in a way that is not direct.",
        examples: [
          "There's a subtle difference between 'eager' and 'keen' in British usage.",
          "Her subtle humour often went unnoticed by people who didn't know her well."
        ],
        collocations: ["subtle difference", "subtle hint", "subtle irony", "subtle distinction"],
        register: "neutral to formal",
        frenchError: "The 'b' in 'subtle' is silent! French speakers often mispronounce it. The word is /ËˆsÊŒtl/, not /ËˆsÊŒbtl/.",
        fr: "subtil / nuancÃ© / fin"
      },
      {
        word: "plausible", phonetic: "/ËˆplÉ”ËzÉªbl/", pos: "adjective",
        definition: "Seeming reasonable or probable; convincing, though not necessarily true.",
        examples: [
          "She offered a plausible explanation for her absence.",
          "The theory sounds plausible, but there isn't enough evidence yet."
        ],
        collocations: ["plausible explanation", "plausible theory", "plausible excuse", "barely plausible"],
        register: "neutral to formal",
        frenchError: "French speakers use 'plausible' â€” same word, but in English it's often used with more scepticism: it sounds possible, but you're not fully convinced.",
        fr: "plausible / vraisemblable / crÃ©dible"
      },
      {
        word: "prone", phonetic: "/proÊŠn/", pos: "adjective",
        definition: "Likely to suffer from or be affected by something negative; also: lying face downward.",
        examples: [
          "He's prone to exaggerating when he's nervous.",
          "People who work outdoors are more prone to skin damage."
        ],
        collocations: ["prone to", "accident-prone", "error-prone", "prone to mistakes"],
        register: "neutral",
        frenchError: "French speakers say 'sujet Ã ' â€” 'prone to' is the exact equivalent but requires the infinitive: 'prone to making errors', not 'prone to errors make'.",
        fr: "sujet Ã  / enclin Ã  / prÃ©disposÃ© Ã "
      },
      {
        word: "nuance", phonetic: "/ËˆnjuËÉ‘Ëns/", pos: "noun",
        definition: "A subtle difference in meaning, expression, or sound; fine detail that changes interpretation.",
        examples: [
          "The translator failed to capture the nuances of the original text.",
          "Understanding cultural nuance is essential for effective communication."
        ],
        collocations: ["subtle nuance", "cultural nuance", "nuance of meaning", "lack of nuance"],
        register: "formal to neutral",
        frenchError: "Direct French cognate â€” but French speakers often use it only in literary contexts. In English, 'nuance' is common in everyday discussions about language, culture, and interpretation.",
        fr: "nuance / subtilitÃ© / finesse"
      }
    ],
    grammar: {
      topic: "Conditionals â€” Zero, First, Second (With Common Mistakes)",
      level: "B1+",
      explanation: `<h4>Zero Conditional â€” General Truth</h4>
<p>If + present simple â†’ present simple</p>
<div class="formula">If you heat water to 100Â°C, it boils.</div>
<p>Use for facts, laws of nature, habits. "When" can replace "if".</p>
<h4>First Conditional â€” Real Future Possibility</h4>
<p>If + present simple â†’ will + infinitive</p>
<div class="formula">If she calls, I will tell her the news.</div>
<div class="warning">Never use "will" in the if-clause: âœ— "If she will call..." â†’ âœ“ "If she calls..."</div>
<h4>Second Conditional â€” Unreal / Hypothetical Present</h4>
<p>If + past simple â†’ would + infinitive</p>
<div class="formula">If I had more time, I would learn Japanese.</div>
<p>The past tense does NOT indicate past time here â€” it signals unreality.</p>
<div class="warning">French interference: French speakers often mix "si + conditionnel" (incorrect in both languages). Remember: "if" clause = no "would" or "would" clause = no "if".</div>
<div class="exception">Special case: "If I were youâ€¦" â€” use "were" (not "was") for formal/correct English, though "was" is common informally. Both are acceptable in modern usage.</div>
<h4>Mixed Types</h4>
<p>It's possible to mix: <span class="example-en">"If I had taken the job (2nd), I would be living in London now (2nd)."</span><br>
Or with time shift: <span class="example-en">"If I had studied harder (3rd â€” past), I would have a degree now (2nd â€” present)."</span></p>`,
      exercises: [
        {
          type: "Error Correction",
          prompt: "Correct the error: \"If she will accept the offer, she will move to London.\"",
          answer: "If she accepts the offer, she will move to London.",
          explanation: "No 'will' in the if-clause of First Conditional"
        },
        {
          type: "Sentence Transformation",
          prompt: "Transform to Second Conditional: \"I don't have a car, so I can't drive you.\"",
          answer: "If I had a car, I could / would drive you.",
          explanation: "Hypothetical present situation â†’ Second Conditional"
        },
        {
          type: "Gap Fill",
          prompt: "Complete: \"If you ______ (mix) blue and yellow, you ______ (get) green.\"",
          answer: "mix / get",
          explanation: "Scientific fact â†’ Zero Conditional"
        },
        {
          type: "Translation",
          prompt: "Translate: \"Si j'Ã©tais toi, je lui parlerais directement.\"",
          answer: "If I were you, I would speak to her directly.",
          explanation: "French 'si + imparfait + conditionnel' = English Second Conditional"
        }
      ]
    }
  },

  // LESSON 3
  {
    id: 3,
    module: "Advanced Nuance",
    level: "B2",
    vocabulary: [
      {
        word: "contentious", phonetic: "/kÉ™nËˆtenÊƒÉ™s/", pos: "adjective",
        definition: "Causing or likely to cause argument; controversial; also: likely to argue.",
        examples: [
          "Immigration remains one of the most contentious political issues.",
          "The decision was contentious among committee members."
        ],
        collocations: ["contentious issue", "contentious topic", "deeply contentious", "contentious debate"],
        register: "formal",
        frenchError: "French speakers may use 'controversÃ©' â€” while similar, 'contentious' also implies active disagreement, not just controversy.",
        fr: "controversÃ© / litigieux / sujet Ã  polÃ©mique"
      },
      {
        word: "diminish", phonetic: "/dÉªËˆmÉªnÉªÊƒ/", pos: "verb",
        definition: "To make or become less; to reduce in size, importance, or quality.",
        examples: [
          "Nothing can diminish her achievements.",
          "The pain gradually diminished over the following days."
        ],
        collocations: ["diminish in importance", "diminish returns", "self-diminishing", "diminished responsibility"],
        register: "formal to neutral",
        frenchError: "French speakers use 'diminuer' â€” close cognate, but 'diminish' often implies qualitative reduction, not just numerical.",
        fr: "diminuer / rÃ©duire / amoindrir"
      },
      {
        word: "inadvertently", phonetic: "/ËŒÉªnÉ™dËˆvÉœËtÉ™ntli/", pos: "adverb",
        definition: "Without intending to; accidentally.",
        examples: [
          "She inadvertently revealed the surprise by mentioning the venue.",
          "The policy inadvertently made the situation worse."
        ],
        collocations: ["inadvertently reveal", "inadvertently cause", "inadvertently omit", "inadvertently offend"],
        register: "formal",
        frenchError: "French speakers say 'sans le vouloir' or 'par inadvertance' â€” 'inadvertently' is more compact and formal, preferred in written English.",
        fr: "sans le vouloir / par inadvertance / involontairement"
      },
      {
        word: "pragmatic", phonetic: "/prÃ¦É¡ËˆmÃ¦tÉªk/", pos: "adjective",
        definition: "Dealing with things sensibly and realistically; focusing on practical solutions rather than theory.",
        examples: [
          "We need a pragmatic approach rather than an idealistic one.",
          "She was pragmatic enough to accept a compromise."
        ],
        collocations: ["pragmatic approach", "pragmatic solution", "be pragmatic about", "pragmatic thinker"],
        register: "formal to neutral",
        frenchError: "French cognate 'pragmatique' exists â€” but French speakers sometimes overuse 'practical'. 'Pragmatic' implies a deliberate rejection of idealism.",
        fr: "pragmatique / rÃ©aliste / pratique"
      },
      {
        word: "elusive", phonetic: "/ÉªËˆluËsÉªv/", pos: "adjective",
        definition: "Difficult to find, catch, or achieve; hard to understand or define clearly.",
        examples: [
          "The exact cause of the disease remained elusive.",
          "Success in the music industry can be elusive."
        ],
        collocations: ["remain elusive", "prove elusive", "elusive dream", "elusive concept"],
        register: "formal to neutral",
        frenchError: "French speakers may use 'difficile Ã  trouver' â€” 'elusive' implies something actively avoiding capture or definition.",
        fr: "insaisissable / difficile Ã  cerner / fuyant"
      },
      {
        word: "pervasive", phonetic: "/pÉ™ËˆveÉªsÉªv/", pos: "adjective",
        definition: "Spreading widely throughout an area or group; present everywhere.",
        examples: [
          "Social media has had a pervasive influence on modern culture.",
          "A pervasive sense of unease hung over the community."
        ],
        collocations: ["pervasive influence", "pervasive problem", "become pervasive", "pervasive culture"],
        register: "formal",
        frenchError: "French speakers use 'omniprÃ©sent' or 'rÃ©pandu' â€” 'pervasive' suggests gradual, invisible spreading, like a smell or ideology, not just wide presence.",
        fr: "omniprÃ©sent / rÃ©pandu / envahissant"
      },
      {
        word: "imperative", phonetic: "/ÉªmËˆperÉ™tÉªv/", pos: "adjective / noun",
        definition: "Adjective: of vital importance; absolutely necessary. Noun: an urgent or obligatory requirement.",
        examples: [
          "It is imperative that we act quickly.",
          "The moral imperative to help those in need cannot be ignored."
        ],
        collocations: ["moral imperative", "absolutely imperative", "it is imperative that", "commercial imperative"],
        register: "formal",
        frenchError: "French speakers may use 'impÃ©ratif' similarly â€” note that 'it is imperative that' is followed by the subjunctive: '...that he be informed' (not 'is informed') in formal English.",
        fr: "impÃ©ratif / indispensable / primordial"
      },
      {
        word: "concede", phonetic: "/kÉ™nËˆsiËd/", pos: "verb",
        definition: "To admit that something is true or correct after denying it; to yield or give up.",
        examples: [
          "He conceded that the project had not gone as planned.",
          "The team conceded three goals in the second half."
        ],
        collocations: ["concede a point", "concede defeat", "concede ground", "reluctantly concede"],
        register: "formal to neutral",
        frenchError: "French speakers use 'concÃ©der' â€” close, but 'concede' in English often has a combative nuance: you're giving in after resistance.",
        fr: "concÃ©der / admettre / cÃ©der"
      },
      {
        word: "meticulous", phonetic: "/mÉªËˆtÉªkjÊŠlÉ™s/", pos: "adjective",
        definition: "Very careful and precise, with great attention to detail.",
        examples: [
          "She kept meticulous records of all her expenses.",
          "The restoration work required meticulous attention to the original design."
        ],
        collocations: ["meticulous attention", "meticulous planning", "meticulous detail", "meticulous records"],
        register: "formal to neutral",
        frenchError: "French speakers may use 'minutieux' â€” close equivalent, but 'meticulous' has a stronger connotation of thoroughness and checking.",
        fr: "mÃ©ticuleux / minutieux / rigoureux"
      },
      {
        word: "ambiguous", phonetic: "/Ã¦mËˆbÉªÉ¡juÉ™s/", pos: "adjective",
        definition: "Having more than one possible meaning or interpretation; unclear.",
        examples: [
          "The wording of the contract was ambiguous and led to disputes.",
          "His response was deliberately ambiguous."
        ],
        collocations: ["morally ambiguous", "deliberately ambiguous", "ambiguous wording", "remain ambiguous"],
        register: "formal to neutral",
        frenchError: "French cognate 'ambigu' exists â€” in English, 'ambiguous' is the most common formal choice. Beware: 'ambiguity' is noun form, not 'ambiguousness' (less common).",
        fr: "ambigu / Ã©quivoque / Ã  double sens"
      }
    ],
    grammar: {
      topic: "Third Conditional & Mixed Conditionals â€” Advanced Use",
      level: "B2",
      explanation: `<h4>Third Conditional â€” Unreal Past</h4>
<p>If + past perfect â†’ would have + past participle</p>
<div class="formula">If I had studied harder, I would have passed the exam.</div>
<p>Used for hypothetical situations in the past that did NOT happen. The regret or relief tense.</p>
<h4>Mixed Conditional â€” Past Cause, Present Effect</h4>
<div class="formula">If + past perfect â†’ would + infinitive (now)</div>
<p><span class="example-en">"If I had taken that job, I would be living in New York now."</span><br>
(Past decision â†’ present consequence)</p>
<h4>Mixed Conditional â€” Present Cause, Past Effect</h4>
<div class="formula">If + past simple â†’ would have + past participle</div>
<p><span class="example-en">"If I were braver, I would have spoken up at the meeting."</span><br>
(Present character â†’ past consequence)</p>
<div class="warning">French trap: 'Si j'avais su, j'aurais dit' â†’ "If I had known, I would have said" â€” never "If I would have knownâ€¦" which is a frequent error.</div>
<h4>Inversion for Formality</h4>
<p>In formal written English, you can invert the subject and auxiliary instead of using "if":</p>
<div class="formula">Had I known â†’ If I had known<br>Were she to leave â†’ If she were to leave<br>Should you need â†’ If you should need</div>
<div class="exception">These inversions are common in formal letters, legal documents, and literary writing. Knowing them is essential for C1 level.</div>`,
      exercises: [
        {
          type: "Error Correction",
          prompt: "Correct: \"If I would have known about the problem, I would have fixed it.\"",
          answer: "If I had known about the problem, I would have fixed it.",
          explanation: "Never use 'would have' in the if-clause"
        },
        {
          type: "Formal Rewrite",
          prompt: "Rewrite using inversion: \"If she had arrived earlier, she would have met him.\"",
          answer: "Had she arrived earlier, she would have met him.",
          explanation: "Formal inversion: omit 'if', move 'had' before subject"
        },
        {
          type: "Mixed Conditional",
          prompt: "Combine: \"I didn't bring a map. I am lost now.\"",
          answer: "If I had brought a map, I wouldn't be lost now.",
          explanation: "Past cause + present effect â†’ Mixed Conditional"
        },
        {
          type: "Translation",
          prompt: "Translate: \"Si tu m'avais dit la vÃ©ritÃ©, je ne t'aurais pas puni.\"",
          answer: "If you had told me the truth, I wouldn't have punished you.",
          explanation: "French third conditional â†’ English third conditional"
        }
      ]
    }
  },

  // LESSON 4
  {
    id: 4,
    module: "Phrasal Verbs Focus",
    level: "B2",
    vocabulary: [
      {
        word: "put off", phonetic: "/pÊŠt É’f/", pos: "phrasal verb",
        definition: "1. To postpone or delay. 2. To cause someone to dislike or lose interest in something.",
        examples: [
          "Don't put off making that doctor's appointment any longer.",
          "The strong smell put me off my food completely."
        ],
        collocations: ["put off until", "put off by", "put it off", "stop putting it off"],
        register: "informal to neutral",
        frenchError: "French speakers forget the double meaning â€” 'put off' means both 'postpone' (remettre) and 'discourage' (dÃ©courager). Context is key.",
        fr: "remettre Ã  plus tard / dÃ©courager / dÃ©goÃ»ter"
      },
      {
        word: "bring about", phonetic: "/brÉªÅ‹ É™ËˆbaÊŠt/", pos: "phrasal verb",
        definition: "To cause something to happen; to produce a result or change.",
        examples: [
          "The reforms brought about significant improvements in healthcare.",
          "What brought about this sudden change of heart?"
        ],
        collocations: ["bring about change", "bring about an end", "bring about reform", "help bring about"],
        register: "neutral to formal",
        frenchError: "French speakers say 'provoquer' or 'entraÃ®ner' â€” 'bring about' implies intentional or consequential causation, often of positive change.",
        fr: "provoquer / entraÃ®ner / engendrer"
      },
      {
        word: "come across", phonetic: "/kÊŒm É™ËˆkrÉ’s/", pos: "phrasal verb",
        definition: "1. To find or encounter something by chance. 2. To give a particular impression.",
        examples: [
          "I came across this article and thought you'd find it interesting.",
          "She comes across as very confident in interviews."
        ],
        collocations: ["come across as", "come across something", "the way you come across", "come across well"],
        register: "informal to neutral",
        frenchError: "The second meaning ('give an impression') is often missed. French speakers focus only on 'trouver par hasard' and forget 'donner l'impression de'.",
        fr: "tomber sur / donner l'impression de / paraÃ®tre"
      },
      {
        word: "take on", phonetic: "/teÉªk É’n/", pos: "phrasal verb",
        definition: "1. To accept a responsibility or task. 2. To employ someone. 3. To compete against.",
        examples: [
          "She agreed to take on the new project despite her workload.",
          "The company took on fifty new employees this quarter."
        ],
        collocations: ["take on responsibility", "take on staff", "take on too much", "take on a challenge"],
        register: "neutral",
        frenchError: "Three meanings that confuse French speakers: prendre en charge (task), embaucher (employ), affronter (compete). Context determines which!",
        fr: "prendre en charge / embaucher / affronter"
      },
      {
        word: "get away with", phonetic: "/É¡et É™ËˆweÉª wÉªÃ°/", pos: "phrasal verb",
        definition: "To do something wrong or dishonest without being punished or caught.",
        examples: [
          "He thought he could get away with not filing his taxes.",
          "Don't let them get away with treating you like that."
        ],
        collocations: ["get away with it", "get away with murder", "you can't get away with", "let someone get away with"],
        register: "informal",
        frenchError: "French speakers sometimes use 's'en tirer' â€” 'get away with' specifically implies doing something wrong AND escaping consequences.",
        fr: "s'en tirer / se tirer d'affaire / passer entre les mailles"
      },
      {
        word: "make out", phonetic: "/meÉªk aÊŠt/", pos: "phrasal verb",
        definition: "1. To claim or pretend. 2. To understand or see something with difficulty. 3. (informal) To manage.",
        examples: [
          "He made out that he hadn't heard the news, but I didn't believe him.",
          "I could just make out a figure in the fog."
        ],
        collocations: ["make out that", "make it out", "hard to make out", "can you make out"],
        register: "informal to neutral",
        frenchError: "Multiple meanings again â€” French speakers need to distinguish between 'prÃ©tendre' (claim), 'distinguer' (see), and 's'en sortir' (manage).",
        fr: "prÃ©tendre / distinguer / dÃ©chiffrer"
      },
      {
        word: "go through", phonetic: "/É¡oÊŠ Î¸ruË/", pos: "phrasal verb",
        definition: "1. To experience something difficult. 2. To examine carefully. 3. To pass or be approved.",
        examples: [
          "She went through a difficult period after the divorce.",
          "Let's go through the contract clause by clause."
        ],
        collocations: ["go through a phase", "go through difficult times", "go through documents", "go through with"],
        register: "neutral",
        frenchError: "French speakers often only use 'traverser' for the experiential meaning â€” don't forget 'go through' also means 'examine' (parcourir) and 'be approved' (passer).",
        fr: "traverser / passer par / examiner / Ãªtre approuvÃ©"
      },
      {
        word: "run out of", phonetic: "/rÊŒn aÊŠt É’v/", pos: "phrasal verb",
        definition: "To have no more of something left; to exhaust a supply.",
        examples: [
          "We've run out of coffee â€” can you pick some up?",
          "I completely ran out of ideas halfway through the project."
        ],
        collocations: ["run out of time", "run out of money", "run out of patience", "run out of ideas"],
        register: "informal to neutral",
        frenchError: "French speakers say 'manquer de' â€” note: 'run out of' is always transitive and implies complete depletion, not just having too little.",
        fr: "manquer de / ne plus avoir de / Ãªtre Ã  court de"
      },
      {
        word: "look into", phonetic: "/lÊŠk ËˆÉªntuË/", pos: "phrasal verb",
        definition: "To investigate or examine a matter.",
        examples: [
          "The committee is looking into the allegations.",
          "Could you look into the cost of the new system?"
        ],
        collocations: ["look into a matter", "look into options", "thoroughly look into", "look into it"],
        register: "neutral to formal",
        frenchError: "French speakers say 'examiner' or 'enquÃªter sur' â€” 'look into' is more neutral and can be used in both formal and informal contexts.",
        fr: "examiner / se pencher sur / enquÃªter sur"
      },
      {
        word: "set out", phonetic: "/set aÊŠt/", pos: "phrasal verb",
        definition: "1. To begin a journey. 2. To explain or present information clearly. 3. To intend to do something.",
        examples: [
          "They set out at dawn to avoid the traffic.",
          "The report sets out the key findings of the study."
        ],
        collocations: ["set out to do", "set out on a journey", "clearly set out", "set out the terms"],
        register: "neutral to formal",
        frenchError: "French speakers confuse 'partir' (journey) with 'prÃ©senter/Ã©noncer' (explain) â€” 'set out' covers both. The third meaning (intend) is most often missed.",
        fr: "partir / prÃ©senter clairement / se donner pour objectif"
      }
    ],
    grammar: {
      topic: "Passive Voice â€” All Tenses & Advanced Structures",
      level: "B2",
      explanation: `<h4>Why Use the Passive?</h4>
<p>âœ¦ When the agent (doer) is unknown, unimportant, or obvious<br>
âœ¦ To focus on the action or result rather than the actor<br>
âœ¦ To sound more formal or impersonal</p>
<h4>Formation Across Tenses</h4>
<div class="formula">be (in correct tense) + past participle</div>
<p>Present: <span class="example-en">"The report is written daily."</span><br>
Past: <span class="example-en">"The bridge was built in 1901."</span><br>
Future: <span class="example-en">"The results will be announced tomorrow."</span><br>
Present Perfect: <span class="example-en">"The decision has been made."</span><br>
Past Perfect: <span class="example-en">"The contract had been signed before we arrived."</span><br>
Continuous: <span class="example-en">"The building is being renovated."</span></p>
<h4>Advanced Passive Structures</h4>
<p>Double object verbs: <span class="example-en">"She was given a promotion."</span> / <span class="example-en">"A promotion was given to her."</span><br>
Reporting verbs: <span class="example-en">"It is said that..." / "He is believed to be..."</span><br>
Passive infinitive: <span class="example-en">"She wants to be promoted."</span><br>
Passive gerund: <span class="example-en">"She resented being overlooked."</span></p>
<div class="warning">French interference: French speakers often add 'par' (by) unnecessarily. Only include the agent when it adds information: "The novel was written BY Orwell" is useful. "The door was opened BY someone" adds nothing.</div>
<div class="exception">Some verbs are rarely passivised: 'suit', 'resemble', 'lack', 'have' (possession sense). âœ— "A solution is lacked by them." â†’ âœ“ "They lack a solution."</div>`,
      exercises: [
        {
          type: "Transformation",
          prompt: "Make passive: \"Someone has stolen my bicycle.\"",
          answer: "My bicycle has been stolen.",
          explanation: "Present Perfect Passive: has/have been + past participle"
        },
        {
          type: "Reporting Verb",
          prompt: "Rewrite: \"People believe that he is innocent.\"",
          answer: "He is believed to be innocent. / It is believed that he is innocent.",
          explanation: "Two possible passive structures for reporting verbs"
        },
        {
          type: "Error Correction",
          prompt: "Correct: \"The letter was wrote by her assistant.\"",
          answer: "The letter was written by her assistant.",
          explanation: "Past participle required: wrote â†’ written"
        },
        {
          type: "Translation",
          prompt: "Translate: \"On dit qu'il a Ã©tÃ© renvoyÃ© la semaine derniÃ¨re.\"",
          answer: "It is said that he was fired/dismissed last week. / He is said to have been fired last week.",
          explanation: "Impersonal passive + perfect infinitive for past reference"
        }
      ]
    }
  },

  // LESSON 5
  {
    id: 5,
    module: "Academic English",
    level: "B2+",
    vocabulary: [
      {
        word: "substantiate", phonetic: "/sÉ™bËˆstÃ¦nÊƒieÉªt/", pos: "verb",
        definition: "To provide evidence to prove or support a claim.",
        examples: [
          "The data was not sufficient to substantiate the hypothesis.",
          "Can you substantiate that claim with concrete examples?"
        ],
        collocations: ["substantiate a claim", "substantiate an argument", "fully substantiate", "fail to substantiate"],
        register: "academic / formal",
        frenchError: "French speakers say 'Ã©tayer' or 'justifier' â€” 'substantiate' specifically implies providing concrete evidence, stronger than just supporting an argument.",
        fr: "Ã©tayer / justifier / prouver"
      },
      {
        word: "epitome", phonetic: "/ÉªËˆpÉªtÉ™mi/", pos: "noun",
        definition: "A person or thing that is a perfect example of a quality or type.",
        examples: [
          "She is the epitome of elegance.",
          "The building is the epitome of modernist architecture."
        ],
        collocations: ["epitome of", "the very epitome", "perfect epitome"],
        register: "formal to literary",
        frenchError: "Often mispronounced â€” it's /ÉªËˆpÉªtÉ™mi/ not /ËˆepÉªtom/. French speakers also confuse it with 'Ã©pitaphe' or 'Ã©pithÃ¨te'. It means the quintessential example.",
        fr: "quintessence / incarnation / modÃ¨le parfait"
      },
      {
        word: "dichotomy", phonetic: "/daÉªËˆkÉ’tÉ™mi/", pos: "noun",
        definition: "A division or contrast between two things that are opposites or very different.",
        examples: [
          "There is a false dichotomy between economic growth and environmental protection.",
          "The essay explores the dichotomy between public persona and private reality."
        ],
        collocations: ["false dichotomy", "sharp dichotomy", "explore a dichotomy", "the dichotomy between"],
        register: "academic / formal",
        frenchError: "French cognate 'dichotomie' exists â€” both are formal. Note: always 'dichotomy BETWEEN X AND Y', not 'of' or 'with'.",
        fr: "dichotomie / opposition / dualitÃ©"
      },
      {
        word: "inherent", phonetic: "/ÉªnËˆhÉªÉ™rÉ™nt/", pos: "adjective",
        definition: "Existing as a permanent, essential, or characteristic feature of something.",
        examples: [
          "There are inherent risks in any financial investment.",
          "Creativity is not inherent to any particular profession."
        ],
        collocations: ["inherent risk", "inherent flaw", "inherent in", "inherent tension"],
        register: "formal",
        frenchError: "French speakers use 'inhÃ©rent' â€” same word, but preposition differs: English uses 'inherent IN something', not 'inherent TO something' (though 'to' appears in some formal contexts).",
        fr: "inhÃ©rent / intrinsÃ¨que / fondamental"
      },
      {
        word: "juxtapose", phonetic: "/ËŒdÊ’ÊŒkstÉ™ËˆpoÊŠz/", pos: "verb",
        definition: "To place two things side by side to show the contrast or comparison between them.",
        examples: [
          "The documentary juxtaposes archival footage with modern interviews.",
          "The poem juxtaposes images of beauty and decay."
        ],
        collocations: ["juxtapose with", "sharply juxtaposed", "juxtapose images", "in juxtaposition to"],
        register: "academic / formal",
        frenchError: "French cognate 'juxtaposer' exists. In English, always followed by 'with' or used with 'juxtaposition of X and Y'. The noun is 'juxtaposition'.",
        fr: "juxtaposer / mettre en contraste / confronter"
      },
      {
        word: "predicated", phonetic: "/ËˆpredÉªkeÉªtÉªd/", pos: "adjective",
        definition: "Based on or depending on a particular assumption or condition.",
        examples: [
          "The plan is predicated on the assumption that funding will continue.",
          "His argument is predicated on questionable data."
        ],
        collocations: ["predicated on", "predicated upon", "entirely predicated"],
        register: "academic / very formal",
        frenchError: "No direct French cognate â€” French speakers say 'basÃ© sur' or 'fondÃ© sur'. 'Predicated on' is more formal and implies logical dependency.",
        fr: "fondÃ© sur / basÃ© sur / conditionnÃ© par"
      },
      {
        word: "nuanced", phonetic: "/ËˆnjuËÉ‘Ënst/", pos: "adjective",
        definition: "Showing careful attention to subtle differences; characterized by nuance.",
        examples: [
          "His analysis was impressively nuanced.",
          "We need a more nuanced approach to this complex issue."
        ],
        collocations: ["nuanced view", "nuanced approach", "nuanced understanding", "highly nuanced"],
        register: "academic / formal",
        frenchError: "French speakers use 'nuancÃ©' â€” perfect cognate. But in English, 'nuanced' is also frequently used as praise: saying work is 'nuanced' = sophisticated and not simplistic.",
        fr: "nuancÃ© / subtil / avec beaucoup de finesse"
      },
      {
        word: "mitigate", phonetic: "/ËˆmÉªtÉªÉ¡eÉªt/", pos: "verb",
        definition: "To lessen the severity, seriousness, or painfulness of something.",
        examples: [
          "Several steps were taken to mitigate the environmental impact.",
          "The defendant's good character was cited to mitigate the sentence."
        ],
        collocations: ["mitigate risk", "mitigate damage", "mitigate against", "help mitigate"],
        register: "formal",
        frenchError: "French speakers may confuse 'mitigate' with 'mitigÃ©' (mixed/lukewarm in French). They are NOT the same! 'Mitigate' = reduce harm; 'mitigÃ©' = mixed feelings.",
        fr: "attÃ©nuer / rÃ©duire / limiter les dÃ©gÃ¢ts"
      },
      {
        word: "commensurate", phonetic: "/kÉ™ËˆmenÊƒÉ™rÉªt/", pos: "adjective",
        definition: "Corresponding in size or degree; in proportion to something.",
        examples: [
          "Her salary should be commensurate with her experience.",
          "The punishment must be commensurate with the offence."
        ],
        collocations: ["commensurate with", "commensurate salary", "commensurate experience", "broadly commensurate"],
        register: "formal / academic",
        frenchError: "French speakers may use 'proportionnel Ã ' â€” 'commensurate with' is the formal English equivalent, very common in job advertisements and legal contexts.",
        fr: "proportionnel Ã  / Ã  la mesure de / en rapport avec"
      },
      {
        word: "trajectory", phonetic: "/trÉ™ËˆdÊ’ektÉ™ri/", pos: "noun",
        definition: "The path or course of something over time; the development or progression of something.",
        examples: [
          "The company's growth trajectory has been impressive.",
          "Her career trajectory took an unexpected turn after the promotion."
        ],
        collocations: ["career trajectory", "growth trajectory", "upward trajectory", "change trajectory"],
        register: "formal to neutral",
        frenchError: "French cognate 'trajectoire' is perfect. In English, 'trajectory' is now widely used metaphorically for careers, economies, projects â€” not just physical paths.",
        fr: "trajectoire / Ã©volution / courbe"
      }
    ],
    grammar: {
      topic: "Modal Verbs for Deduction, Probability & Criticism",
      level: "B2+",
      explanation: `<h4>Present Deduction</h4>
<div class="formula">must / can't / could / might + bare infinitive</div>
<p><span class="example-en">"She must be tired"</span> â€” almost certain (positive)<br>
<span class="example-en">"He can't be serious"</span> â€” almost certain (negative)<br>
<span class="example-en">"They might be stuck in traffic"</span> â€” possible<br>
<span class="example-en">"It could be a misunderstanding"</span> â€” possible</p>
<h4>Past Deduction</h4>
<div class="formula">must / can't / could / might + have + past participle</div>
<p><span class="example-en">"She must have forgotten."</span> â€” almost certain past<br>
<span class="example-en">"He can't have known."</span> â€” almost certain past negative<br>
<span class="example-en">"They might have misunderstood."</span> â€” possible past</p>
<h4>Criticism of Past Actions</h4>
<div class="formula">should / shouldn't + have + past participle</div>
<p><span class="example-en">"You should have called me."</span> â€” criticism: you didn't, but you should have<br>
<span class="example-en">"She shouldn't have said that."</span> â€” criticism: she did, but shouldn't have</p>
<div class="formula">needn't have + past participle vs didn't need to</div>
<p><span class="example-en">"You needn't have bought flowers"</span> â€” you did, but it wasn't necessary<br>
<span class="example-en">"You didn't need to buy flowers"</span> â€” it wasn't necessary (may or may not have done it)</p>
<div class="warning">French trap: French speakers often use 'devoir' for all modals. 'Must have done' â‰  'had to do' â€” 'had to' = obligation; 'must have done' = deduction.</div>
<div class="exception">'Could have' = past possibility that wasn't taken: "You could have asked for help." â€” implies they didn't and perhaps should have.</div>`,
      exercises: [
        {
          type: "Deduction",
          prompt: "React: There's no answer at the door and the lights are off. \"They ______ out.\" (certainty)",
          answer: "They must be out.",
          explanation: "High certainty deduction about present â†’ must + infinitive"
        },
        {
          type: "Error Correction",
          prompt: "Correct: \"You should have tell me about the meeting.\"",
          answer: "You should have told me about the meeting.",
          explanation: "After modal + have, use past participle (told, not tell)"
        },
        {
          type: "Past Modal",
          prompt: "He looks exhausted. Transform: \"It is possible that he didn't sleep.\" (might)",
          answer: "He might not have slept.",
          explanation: "Past possibility (negative) â†’ might not have + past participle"
        },
        {
          type: "Translation",
          prompt: "Translate: \"Il aurait dÃ» te prÃ©venir â€” c'est sa faute.\"",
          answer: "He should have warned you â€” it's his fault.",
          explanation: "Past criticism: conditionnel passÃ© in French = should have in English"
        }
      ]
    }
  }
];

// ============================================================
// STORAGE
// ============================================================
const S = {
  get(k) { try { return JSON.parse(localStorage.getItem('ascend_' + k)); } catch { return null; } },
  set(k, v) { try { localStorage.setItem('ascend_' + k, JSON.stringify(v)); } catch {} },
  data() {
    const d = this.get('data') || {
      completedLessons: [],
      streak: 0,
      lastLessonDate: null,
      wordsLearned: [],
      errors: [],
      testResults: [],
      totalAnswers: 0,
      correctAnswers: 0,
      currentLessonId: 1,
      grammarHistory: []
    };
    return d;
  },
  save(d) { this.set('data', d); }
};

// ============================================================
// STATE
// ============================================================
let appData = S.data();
let currentLesson = null;
let lessonPhase = 'vocab'; // vocab | exercises | grammar | grammar_exercises | complete
let currentWordIndex = 0;
let exerciseStates = {};
let grammarExerciseStates = {};
let testState = null;

// ============================================================
// INIT
// ============================================================
function init() {
  updateStreak();
  renderTopDate();
  loadLesson();
  updateSidebarStats();
  checkTestBadge();
}

function updateStreak() {
  const d = appData;
  const today = todayStr();
  if (d.lastLessonDate !== today && d.lastLessonDate !== null) {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yStr = yesterday.toISOString().split('T')[0];
    if (d.lastLessonDate !== yStr) d.streak = 0;
  }
  document.getElementById('streak-count').textContent = d.streak;
  const pct = Math.min(100, (d.completedLessons.length / (CURRICULUM.length * 2)) * 100);
  document.getElementById('level-fill').style.width = Math.max(5, pct) + '%';
  const levels = ['B1+', 'B1+', 'B2', 'B2', 'B2+', 'B2+', 'C1'];
  const li = Math.min(levels.length - 1, Math.floor(d.completedLessons.length / 2));
  document.getElementById('level-label-text').textContent = levels[li];
}

function updateSidebarStats() {
  // nothing extra needed
}

function todayStr() {
  return new Date().toISOString().split('T')[0];
}

function renderTopDate() {
  const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  document.getElementById('top-date').textContent = new Date().toLocaleDateString('en-GB', opts);
}

// ============================================================
// NAVIGATION
// ============================================================
function showView(view) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('view-' + view).classList.add('active');
  document.querySelector(`[data-view="${view}"]`).classList.add('active');
  const titles = {
    lesson: "Today's Lesson",
    test: "Weekly Test",
    progress: "Progress",
    errors: "Error Log",
    vocab: "Vocabulary Bank",
    grammar: "Grammar Archive"
  };
  document.getElementById('view-title').textContent = titles[view] || view;

  if (view === 'progress') renderProgress();
  if (view === 'errors') renderErrorLog();
  if (view === 'vocab') renderVocabBank();
  if (view === 'grammar') renderGrammarArchive();
  if (view === 'test') renderTest();

  // close mobile sidebar
  document.getElementById('sidebar').classList.remove('open');
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

// ============================================================
// LESSON
// ============================================================
async function loadLesson() {
  const d = appData;
  const lid = d.currentLessonId;
  const staticLesson = CURRICULUM.find(l => l.id === lid);

  if (staticLesson) {
    currentLesson = staticLesson;
    lessonPhase = 'vocab';
    currentWordIndex = 0;
    exerciseStates = {};
    grammarExerciseStates = {};
    renderVocabPhase();
  } else {
    const cached = S.get('ai_lesson_' + lid);
    if (cached) {
      currentLesson = cached;
      lessonPhase = 'vocab';
      currentWordIndex = 0;
      exerciseStates = {};
      grammarExerciseStates = {};
      renderVocabPhase();
    } else {
      await generateAILesson(lid);
    }
  }
}

function renderLessonHeader() {
  const lesson = currentLesson;
  const container = document.getElementById('lesson-container');
  // Phase indicator always at top
  const phaseHtml = `
    <div class="phase-indicator">
      <div class="phase-step ${lessonPhase === 'vocab' ? 'active' : 'done'}" id="pi-vocab">
        <div class="phase-dot"></div>
        <span>Vocabulary</span>
      </div>
      <div class="phase-line"></div>
      <div class="phase-step ${lessonPhase === 'exercises' ? 'active' : (lessonPhase === 'grammar' || lessonPhase === 'grammar_exercises' || lessonPhase === 'complete') ? 'done' : ''}" id="pi-ex">
        <div class="phase-dot"></div>
        <span>Exercises</span>
      </div>
      <div class="phase-line"></div>
      <div class="phase-step ${lessonPhase === 'grammar' || lessonPhase === 'grammar_exercises' ? 'active' : lessonPhase === 'complete' ? 'done' : ''}" id="pi-gram">
        <div class="phase-dot"></div>
        <span>Grammar</span>
      </div>
      <div class="phase-line"></div>
      <div class="phase-step ${lessonPhase === 'complete' ? 'done' : ''}" id="pi-done">
        <div class="phase-dot"></div>
        <span>Complete</span>
      </div>
    </div>`;
  return phaseHtml;
}

function renderVocabPhase() {
  const lesson = currentLesson;
  const word = lesson.vocabulary[currentWordIndex];
  const container = document.getElementById('lesson-container');
  
  const dots = lesson.vocabulary.map((_, i) => {
    let cls = 'word-dot';
    if (i < currentWordIndex) cls += ' done';
    else if (i === currentWordIndex) cls += ' active';
    return `<div class="${cls}"></div>`;
  }).join('');

  const registerTag = word.register.includes('formal') ? 'tag-formal' : word.register.includes('academic') ? 'tag-academic' : word.register.includes('colloquial') || word.register.includes('informal') ? 'tag-informal' : '';
  const collocHtml = word.collocations.map(c => `<span class="tag">${c}</span>`).join('');

  container.innerHTML = renderLessonHeader() + `
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-subtitle">Lesson ${lesson.id} â€” ${lesson.module}</div>
          <div class="card-title">Part I: Vocabulary</div>
        </div>
        <div class="tag ${registerTag.replace('tag-', '') === 'tag-' ? '' : registerTag}">${word.register}</div>
      </div>
      
      <div class="word-nav">
        <div class="word-counter">${currentWordIndex + 1} / ${lesson.vocabulary.length}</div>
        <div class="word-dots">${dots}</div>
      </div>

      <div class="word-display">
        <div class="word-main">${word.word}</div>
        <div class="word-phonetic">${word.phonetic}</div>
        <span class="word-pos">${word.pos}</span>
      </div>

      <div class="word-definition">${word.definition}</div>

      <div class="section-label">Examples</div>
      <div class="word-examples">
        ${word.examples.map(e => `<div class="example-item">"${e}"</div>`).join('')}
      </div>

      <div class="word-meta">
        <div class="meta-box">
          <div class="meta-box-label">Collocations</div>
          <div class="meta-box-content">${collocHtml}</div>
        </div>
        <div class="meta-box">
          <div class="meta-box-label">âš  French Error</div>
          <div class="meta-box-content" style="font-size:12px;color:var(--text3)">${word.frenchError}</div>
        </div>
      </div>

      <div class="word-actions">
        <button class="btn btn-ghost btn-sm" onclick="speak('${word.word.replace(/'/g,"\\'")}')">ğŸ”Š Listen</button>
        <button class="btn btn-ghost btn-sm" onclick="speak('${word.examples[0].replace(/'/g,"\\'")}')">ğŸ”Š Example</button>
        ${currentWordIndex > 0 ? `<button class="btn btn-ghost btn-sm" onclick="prevWord()">â† Previous</button>` : ''}
      </div>

      <div class="reveal-translation" onclick="toggleTranslation(this)">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:0.1em;opacity:0.6;">ğŸ‡«ğŸ‡· Reveal French meaning</div>
        <div class="translation-content translation-hidden">${word.fr}</div>
      </div>
    </div>

    <div style="display:flex;gap:10px;margin-top:4px;">
      ${currentWordIndex < lesson.vocabulary.length - 1 
        ? `<button class="btn btn-primary" onclick="nextWord()">Next Word â†’</button>`
        : `<button class="btn btn-primary" onclick="startExercises()">Start Exercises â†’</button>`
      }
    </div>
  `;
}

function toggleTranslation(el) {
  const content = el.querySelector('.translation-content');
  content.classList.toggle('revealed');
  const hint = el.querySelector('div');
  hint.textContent = content.classList.contains('revealed') ? 'ğŸ‡«ğŸ‡· French meaning shown' : 'ğŸ‡«ğŸ‡· Reveal French meaning';
}

function speak(text) {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'en-GB';
    u.rate = 0.9;
    window.speechSynthesis.speak(u);
  }
}

function nextWord() {
  if (currentWordIndex < currentLesson.vocabulary.length - 1) {
    currentWordIndex++;
    renderVocabPhase();
  }
}

function prevWord() {
  if (currentWordIndex > 0) {
    currentWordIndex--;
    renderVocabPhase();
  }
}

// ============================================================
// EXERCISES
// ============================================================
function startExercises() {
  lessonPhase = 'exercises';
  const lesson = currentLesson;
  const container = document.getElementById('lesson-container');
  
  // Generate exercises from vocabulary
  const exercises = generateVocabExercises(lesson);
  
  let exHtml = exercises.map((ex, i) => `
    <div class="exercise-block" id="ex-block-${i}">
      <div class="exercise-type">${ex.type}</div>
      <div class="exercise-prompt">${ex.prompt}</div>
      <input class="answer-input" id="ans-${i}" placeholder="Your answerâ€¦" onkeydown="if(event.key==='Enter') checkAnswer(${i})">
      <div class="answer-feedback" id="fb-${i}"></div>
      <button class="btn btn-ghost btn-sm check-btn" onclick="checkAnswer(${i})">Check Answer</button>
    </div>
  `).join('');

  container.innerHTML = renderLessonHeader() + `
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-subtitle">Part I: Vocabulary Practice</div>
          <div class="card-title">Exercises</div>
        </div>
      </div>
      ${exHtml}
      <div style="margin-top:20px;">
        <button class="btn btn-primary" onclick="startGrammar()">Continue to Grammar â†’</button>
      </div>
    </div>
  `;
  
  window._exercises = exercises;
}

function generateVocabExercises(lesson) {
  const words = lesson.vocabulary;
  const exs = [];
  
  // Shuffle a copy to vary exercises
  const shuffled = [...words].sort(() => Math.random() - 0.5);
  const w = (i) => shuffled[i % shuffled.length];

  // 1. Definition â†’ Word
  const w0 = w(0);
  exs.push({
    type: 'Definition to Word',
    prompt: `"${w0.definition}" â€” What is the word?`,
    answer: w0.word,
    words: [w0.word],
    hint: w0.word
  });

  // 2. FR â†’ EN gap fill
  const w1 = w(1);
  exs.push({
    type: 'Translation Gap Fill â€” FR â†’ EN',
    prompt: `"${w1.fr}" â€” Complete with the correct English word: "${w1.examples[0].replace(w1.word, '______')}"`,
    answer: w1.word,
    words: [w1.word],
    hint: w1.word
  });

  // 3. Collocation
  const w2 = w(2);
  const collocParts = w2.collocations[0].split(' ');
  const blankIdx = collocParts[0].toLowerCase() === w2.word.toLowerCase() ? 0 : collocParts.length - 1;
  const gapped = collocParts.map((p, i) => i === blankIdx ? '______' : p).join(' ');
  exs.push({
    type: 'Collocation',
    prompt: `Complete the collocation: "${gapped}"<br><small style="color:var(--text3)">(Hint: it's one of today's vocabulary words)</small>`,
    answer: w2.word,
    words: [w2.word],
    hint: w2.word
  });

  // 4. Context sentence fill
  const w3 = w(3);
  const exampleWithBlank = w3.examples[1]
    ? w3.examples[1].replace(new RegExp(w3.word, 'i'), '______')
    : `"${w3.definition.substring(0, 50)}â€¦" â€” which word from today?`;
  exs.push({
    type: 'Context Fill',
    prompt: exampleWithBlank.includes('______') 
      ? `Fill in the blank: "${exampleWithBlank}"` 
      : exampleWithBlank,
    answer: w3.word,
    words: [w3.word],
    hint: w3.word
  });

  // 5. Register / Usage
  const w4 = w(4);
  exs.push({
    type: 'Word Form or Usage',
    prompt: `"${w4.frenchError}"<br><br>Write a sentence using <strong>${w4.word}</strong> correctly:`,
    answer: w4.word,
    words: [w4.word],
    hint: w4.word
  });

  return exs;
}

function checkAnswer(i) {
  const ex = window._exercises[i];
  const input = document.getElementById('ans-' + i);
  const fb = document.getElementById('fb-' + i);
  const val = input.value.trim().toLowerCase();
  
  const correct = ex.hint.toLowerCase();
  const isCorrect = val.includes(correct) || (ex.answer && val.includes(ex.answer.toLowerCase().split(' ')[0]));
  
  input.className = 'answer-input ' + (isCorrect ? 'correct' : 'incorrect');
  fb.className = 'answer-feedback show ' + (isCorrect ? 'success' : 'failure');
  fb.textContent = isCorrect 
    ? `âœ“ Correct! "${ex.hint}" is right.`
    : `âœ— The answer was: "${ex.hint}". ${ex.words ? `Review: ${ex.words.join(', ')}` : ''}`;
  
  // Track errors
  if (!isCorrect) {
    const d = appData;
    const existing = d.errors.find(e => e.word === ex.hint);
    if (existing) existing.count++;
    else d.errors.push({ word: ex.hint, type: ex.type, date: todayStr(), count: 1 });
    d.totalAnswers = (d.totalAnswers || 0) + 1;
    S.save(d);
  } else {
    const d = appData;
    d.totalAnswers = (d.totalAnswers || 0) + 1;
    d.correctAnswers = (d.correctAnswers || 0) + 1;
    S.save(d);
  }
}

// ============================================================
// GRAMMAR
// ============================================================
function startGrammar() {
  lessonPhase = 'grammar';
  const lesson = currentLesson;
  const container = document.getElementById('lesson-container');
  
  container.innerHTML = renderLessonHeader() + `
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-subtitle">Part II: Grammar â€” ${lesson.grammar.level}</div>
          <div class="card-title">${lesson.grammar.topic}</div>
        </div>
      </div>
      <div class="grammar-rule">${lesson.grammar.explanation}</div>
      <button class="btn btn-primary" onclick="startGrammarExercises()">Practice Exercises â†’</button>
    </div>
  `;
}

function startGrammarExercises() {
  lessonPhase = 'grammar_exercises';
  const lesson = currentLesson;
  const container = document.getElementById('lesson-container');
  const exs = lesson.grammar.exercises;
  
  let exHtml = exs.map((ex, i) => `
    <div class="exercise-block">
      <div class="exercise-type">${ex.type}</div>
      <div class="exercise-prompt">${ex.prompt}</div>
      <input class="answer-input" id="gram-ans-${i}" placeholder="Your answerâ€¦" onkeydown="if(event.key==='Enter') checkGrammarAnswer(${i})">
      <div class="answer-feedback" id="gram-fb-${i}"></div>
      <button class="btn btn-ghost btn-sm check-btn" onclick="checkGrammarAnswer(${i})">Check Answer</button>
    </div>
  `).join('');

  container.innerHTML = renderLessonHeader() + `
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-subtitle">Part II: Grammar Practice</div>
          <div class="card-title">${lesson.grammar.topic}</div>
        </div>
      </div>
      ${exHtml}
      <div style="margin-top:20px;">
        <button class="btn btn-primary" onclick="completeLesson()">Complete Lesson âœ“</button>
      </div>
    </div>
  `;
  
  window._gramExercises = exs;
}

function checkGrammarAnswer(i) {
  const ex = window._gramExercises[i];
  const input = document.getElementById('gram-ans-' + i);
  const fb = document.getElementById('gram-fb-' + i);
  const val = input.value.trim().toLowerCase();
  const answerWords = ex.answer.toLowerCase().split(/\s+|\//).map(w => w.replace(/[.,!?]/g, ''));
  
  // Check if at least 60% of key words are present
  const keyWords = answerWords.filter(w => w.length > 3);
  const matchCount = keyWords.filter(w => val.includes(w)).length;
  const isCorrect = matchCount >= Math.max(1, Math.floor(keyWords.length * 0.5));
  
  input.className = 'answer-input ' + (isCorrect ? 'correct' : 'incorrect');
  fb.className = 'answer-feedback show ' + (isCorrect ? 'success' : 'failure');
  fb.innerHTML = isCorrect 
    ? `âœ“ Well done! Model answer: "<em>${ex.answer}</em>"`
    : `âœ— Model answer: "<em>${ex.answer}</em>"<br><small style="opacity:0.7">${ex.explanation}</small>`;
  
  if (!isCorrect) {
    const d = appData;
    d.errors.push({ word: ex.type, type: 'Grammar: ' + window._gramExercises[i].type, date: todayStr(), count: 1 });
    S.save(d);
  }
}

// ============================================================
// COMPLETE LESSON
// ============================================================
function completeLesson() {
  const d = appData;
  const lesson = currentLesson;
  const today = todayStr();
  
  if (!d.completedLessons.includes(lesson.id)) {
    d.completedLessons.push(lesson.id);
    
    // Add words to bank
    lesson.vocabulary.forEach(w => {
      if (!d.wordsLearned.find(v => v.word === w.word)) {
        d.wordsLearned.push({
          word: w.word,
          pos: w.pos,
          definition: w.definition,
          fr: w.fr,
          lessonId: lesson.id,
          date: today
        });
      }
    });
    
    // Update grammar history
    d.grammarHistory.push({
      topic: lesson.grammar.topic,
      level: lesson.grammar.level,
      lessonId: lesson.id,
      date: today
    });
    
    // Update streak
    if (d.lastLessonDate !== today) {
      if (d.lastLessonDate === yesterday()) d.streak = (d.streak || 0) + 1;
      else if (d.lastLessonDate === null) d.streak = 1;
      else d.streak = 1;
    }
    d.lastLessonDate = today;
    
    // Advance lesson â€” always increment, AI will generate next
    d.currentLessonId = lesson.id + 1;
  }
  
  S.save(d);
  appData = d;
  
  document.getElementById('streak-count').textContent = d.streak;
  updateStreak();
  
  lessonPhase = 'complete';
  const container = document.getElementById('lesson-container');
  const wordsCount = lesson.vocabulary.length;
  const isAI = lesson.id > CURRICULUM.length;
  
  container.innerHTML = `
    <div class="lesson-complete">
      <div class="lesson-complete-icon">ğŸ‰</div>
      <div class="lesson-complete-title">Lesson Complete!</div>
      <div class="lesson-complete-text">
        You've learned <strong style="color:var(--accent)">${wordsCount} new words</strong> and studied 
        <strong style="color:var(--accent)">${lesson.grammar.topic}</strong>.<br>
        Current streak: ğŸ”¥ ${d.streak} day${d.streak !== 1 ? 's' : ''}
      </div>
      <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="loadLesson()">${isAI ? 'âœ¦ Generate Next Lesson' : 'Next Lesson â†’'}</button>
        <button class="btn btn-ghost" onclick="showView('vocab')">Vocabulary Bank</button>
      </div>
    </div>
  `;
}

function yesterday() {
  const d = new Date();
  d.setDate(d.getDate() - 1);
  return d.toISOString().split('T')[0];
}

// ============================================================
// WEEKLY TEST
// ============================================================
function checkTestBadge() {
  const d = appData;
  const daysSinceTest = d.testResults.length === 0 ? 999 : 
    Math.floor((Date.now() - new Date(d.testResults[d.testResults.length-1].date)) / 86400000);
  const completedLessons = d.completedLessons.length;
  if (completedLessons >= 3 && daysSinceTest >= 7) {
    document.getElementById('test-badge').style.display = '';
  }
}

function renderTest() {
  const container = document.getElementById('test-container');
  const d = appData;
  
  if (d.wordsLearned.length < 10) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“</div>
        <div class="empty-state-text">Complete at least <strong>3 lessons</strong> to unlock your weekly test.</div>
        <div style="margin-top:20px;"><button class="btn btn-primary" onclick="showView('lesson')">Go to Lesson</button></div>
      </div>
    `;
    return;
  }
  
  if (testState && testState.submitted) {
    renderTestResults();
    return;
  }
  
  if (!testState || testState.submitted) {
    generateTest();
  }
  
  renderTestUI();
}

function generateTest() {
  const d = appData;
  const words = d.wordsLearned.slice(-30); // last 30 words
  
  const questions = [];
  
  // Meaning questions
  words.slice(0, 5).forEach(w => {
    const decoys = words.filter(x => x.word !== w.word).slice(0, 3);
    const options = shuffle([w.definition.substring(0, 80) + 'â€¦', ...decoys.map(x => x.definition.substring(0, 80) + 'â€¦')]);
    questions.push({
      type: 'meaning',
      question: `What does "<strong>${w.word}</strong>" mean?`,
      options,
      answer: options.indexOf(w.definition.substring(0, 80) + 'â€¦')
    });
  });
  
  // Translation questions
  words.slice(5, 10).forEach(w => {
    const decoys = words.filter(x => x.word !== w.word).slice(0, 3);
    const options = shuffle([w.word, ...decoys.map(x => x.word)]);
    questions.push({
      type: 'translation',
      question: `"${w.fr}" â€” which English word matches?`,
      options,
      answer: options.indexOf(w.word)
    });
  });
  
  // Error from log
  if (d.errors.length > 0) {
    const errorWords = d.errors.slice(0, 3);
    errorWords.forEach(err => {
      const w = d.wordsLearned.find(x => x.word === err.word);
      if (w) {
        const decoys = words.filter(x => x.word !== w.word).slice(0, 3);
        const options = shuffle([w.word, ...decoys.map(x => x.word)]);
        questions.push({
          type: 'error_review',
          question: `(Previously missed) "${w.definition.substring(0, 80)}â€¦" â€” which word?`,
          options,
          answer: options.indexOf(w.word)
        });
      }
    });
  }
  
  testState = {
    questions: questions.slice(0, 12),
    answers: {},
    submitted: false
  };
}

function renderTestUI() {
  const container = document.getElementById('test-container');
  const q = testState.questions;
  
  const qHtml = q.map((question, i) => `
    <div class="test-question" id="tq-${i}">
      <div class="test-q-num">Question ${i + 1} of ${q.length} â€” ${question.type.replace('_', ' ')}</div>
      <div class="test-q-text">${question.question}</div>
      <div class="test-options">
        ${question.options.map((opt, j) => `
          <div class="test-option" id="to-${i}-${j}" onclick="selectTestOption(${i}, ${j})">${opt}</div>
        `).join('')}
      </div>
    </div>
  `).join('');
  
  container.innerHTML = `
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-subtitle">Weekly Assessment</div>
          <div class="card-title">Test your knowledge â€” no hints</div>
        </div>
      </div>
      ${qHtml}
      <button class="btn btn-primary" onclick="submitTest()" style="margin-top:8px;">Submit Test</button>
    </div>
  `;
}

function selectTestOption(qi, oi) {
  testState.answers[qi] = oi;
  const q = testState.questions[qi];
  const options = document.querySelectorAll(`#tq-${qi} .test-option`);
  options.forEach((el, i) => {
    el.classList.toggle('selected', i === oi);
  });
}

function submitTest() {
  const q = testState.questions;
  let correct = 0;
  
  q.forEach((question, i) => {
    const userAnswer = testState.answers[i];
    if (userAnswer === question.answer) correct++;
  });
  
  const score = Math.round((correct / q.length) * 100);
  testState.submitted = true;
  testState.score = score;
  testState.correct = correct;
  
  // Save result
  const d = appData;
  d.testResults.push({
    date: todayStr(),
    score,
    correct,
    total: q.length
  });
  S.save(d);
  appData = d;
  
  document.getElementById('test-badge').style.display = 'none';
  
  renderTestResults();
}

function renderTestResults() {
  const container = document.getElementById('test-container');
  const { score, correct, questions } = testState;
  const total = questions.length;
  
  const grade = score >= 90 ? { label: 'Excellent', color: 'var(--success)', msg: 'Outstanding performance! Move to the next level.' } :
                score >= 70 ? { label: 'Good', color: 'var(--accent)', msg: 'Solid work. Review the questions you missed.' } :
                score >= 50 ? { label: 'Fair', color: 'var(--warning)', msg: 'Keep practising. Focus on the Error Log.' } :
                { label: 'Needs Work', color: 'var(--error)', msg: 'Revisit recent lessons before moving on.' };
  
  // Show answers
  const reviewHtml = questions.map((q, i) => {
    const userAns = testState.answers[i];
    const isCorrect = userAns === q.answer;
    return `
      <div class="test-question">
        <div class="test-q-num" style="color:${isCorrect ? 'var(--success)' : 'var(--error)'}">${isCorrect ? 'âœ“' : 'âœ—'} Question ${i+1}</div>
        <div class="test-q-text">${q.question}</div>
        <div style="font-size:13px;margin-top:6px;color:var(--success)">âœ“ ${q.options[q.answer]}</div>
        ${!isCorrect && userAns !== undefined ? `<div style="font-size:13px;color:var(--error)">âœ— You chose: ${q.options[userAns]}</div>` : ''}
      </div>
    `;
  }).join('');
  
  container.innerHTML = `
    <div class="card" style="text-align:center;padding:32px;">
      <div style="font-family:'Playfair Display',serif;font-size:60px;color:${grade.color};line-height:1">${score}%</div>
      <div style="font-family:'IBM Plex Mono',monospace;font-size:14px;color:${grade.color};margin-top:8px;text-transform:uppercase;letter-spacing:0.1em">${grade.label}</div>
      <div style="color:var(--text2);margin-top:12px;font-size:14px">${correct} / ${total} correct â€” ${grade.msg}</div>
      <button class="btn btn-primary" onclick="resetTest()" style="margin-top:20px;">Retake Next Week</button>
    </div>
    <div style="margin-top:20px;">${reviewHtml}</div>
  `;
}

function resetTest() {
  testState = null;
  renderTest();
}

function shuffle(arr) {
  return [...arr].sort(() => Math.random() - 0.5);
}

// ============================================================
// PROGRESS
// ============================================================
function renderProgress() {
  const d = appData;
  document.getElementById('stat-lessons').textContent = d.completedLessons.length;
  document.getElementById('stat-words').textContent = d.wordsLearned.length;
  const acc = d.totalAnswers ? Math.round((d.correctAnswers / d.totalAnswers) * 100) + '%' : 'â€“';
  document.getElementById('stat-accuracy').textContent = acc;
  
  // Week grid
  const weekGrid = document.getElementById('week-grid');
  const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const today = new Date().getDay(); // 0=Sun
  const todayIdx = today === 0 ? 6 : today - 1;
  weekGrid.innerHTML = days.map((day, i) => {
    const cls = i === todayIdx ? 'day-block today' : 'day-block';
    const check = i < todayIdx || i === todayIdx ? 'âœ“' : '';
    return `<div class="${cls}"><div class="day-label">${day}</div><div class="day-check" style="color:var(--success)">${check}</div></div>`;
  }).join('');
  
  // Test history
  const thl = document.getElementById('test-history-list');
  if (d.testResults.length === 0) {
    thl.innerHTML = '<div style="color:var(--text3);font-size:13px">No tests completed yet.</div>';
  } else {
    thl.innerHTML = d.testResults.slice(-5).reverse().map(t => `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)">
        <span style="font-size:13px;color:var(--text2)">${t.date}</span>
        <span style="font-family:'IBM Plex Mono',monospace;font-size:13px;color:${t.score >= 70 ? 'var(--success)' : 'var(--warning)'}">${t.score}%</span>
      </div>
    `).join('');
  }
  
  // Module progress
  const mp = document.getElementById('module-progress');
  const modules = [...new Set(CURRICULUM.map(l => l.module))];
  mp.innerHTML = modules.map(m => {
    const mLessons = CURRICULUM.filter(l => l.module === m);
    const done = mLessons.filter(l => d.completedLessons.includes(l.id)).length;
    const pct = Math.round((done / mLessons.length) * 100);
    return `
      <div style="margin-bottom:14px">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px">
          <span style="font-size:13px">${m}</span>
          <span style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--text3)">${done}/${mLessons.length}</span>
        </div>
        <div class="level-bar"><div class="level-fill" style="width:${pct}%"></div></div>
      </div>
    `;
  }).join('');
}

// ============================================================
// ERROR LOG
// ============================================================
function renderErrorLog() {
  const d = appData;
  const container = document.getElementById('error-list-container');
  
  if (d.errors.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">âš¡</div>
        <div class="empty-state-text">No errors recorded yet. Keep practising!</div>
      </div>
    `;
    return;
  }
  
  // Group and count errors
  const grouped = {};
  d.errors.forEach(e => {
    if (!grouped[e.word]) grouped[e.word] = { ...e, count: 0 };
    grouped[e.word].count++;
  });
  
  const sorted = Object.values(grouped).sort((a, b) => b.count - a.count);
  
  container.innerHTML = `
    <div class="card">
      <div class="section-label">Most frequent errors (${sorted.length})</div>
      ${sorted.map(e => `
        <div class="error-entry">
          <span class="error-entry-count">${e.count}x</span>
          <div class="error-entry-word">${e.word}</div>
          <div class="error-entry-detail">${e.type} â€” ${e.date}</div>
        </div>
      `).join('')}
    </div>
  `;
}

// ============================================================
// VOCABULARY BANK
// ============================================================
function renderVocabBank() {
  const d = appData;
  const grid = document.getElementById('vocab-grid');
  const search = document.getElementById('vocab-search')?.value?.toLowerCase() || '';
  
  const words = d.wordsLearned.filter(w => 
    !search || w.word.toLowerCase().includes(search) || w.definition.toLowerCase().includes(search)
  );
  
  if (words.length === 0) {
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">ğŸ“š</div><div class="empty-state-text">Complete lessons to build your vocabulary bank.</div></div>`;
    return;
  }
  
  grid.innerHTML = words.map(w => `
    <div class="vocab-item" onclick="speakWord('${w.word.replace(/'/g,"\\'")}')">
      <div class="vocab-word">${w.word}</div>
      <div class="vocab-pos">${w.pos}</div>
      <div class="vocab-def">${w.definition.substring(0, 100)}${w.definition.length > 100 ? 'â€¦' : ''}</div>
      <div class="vocab-lesson">Lesson ${w.lessonId} Â· ${w.date}</div>
    </div>
  `).join('');
}

function speakWord(word) {
  speak(word);
}

// ============================================================
// GRAMMAR ARCHIVE
// ============================================================
function renderGrammarArchive() {
  const d = appData;
  const container = document.getElementById('grammar-archive-list');
  
  if (d.grammarHistory.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">âš™</div>
        <div class="empty-state-text">Complete lessons to build your grammar archive.</div>
      </div>
    `;
    return;
  }
  
  const html = d.grammarHistory.map(g => `
    <div class="grammar-archive-item">
      <div>
        <div class="grammar-archive-topic">${g.topic}</div>
        <div class="grammar-archive-lesson">Lesson ${g.lessonId} Â· ${g.date}</div>
      </div>
      <div class="grammar-archive-level">${g.level}</div>
    </div>
  `).join('');
  
  container.innerHTML = `<div class="card"><div class="section-label">Completed grammar topics</div>${html}</div>`;
}

// ============================================================
// AI LESSON GENERATION
// ============================================================

const LEVEL_PROGRESSION = [
  { min: 1,  max: 5,  level: 'B1+', module: 'Everyday UK English' },
  { min: 6,  max: 10, level: 'B2',  module: 'Intermediate Consolidation' },
  { min: 11, max: 15, level: 'B2+', module: 'Advanced Nuance' },
  { min: 16, max: 20, level: 'B2+', module: 'Academic English' },
  { min: 21, max: 25, level: 'C1',  module: 'Complex Grammar' },
  { min: 26, max: 999,level: 'C1',  module: 'C1 Mastery' }
];

const GRAMMAR_TOPICS_POOL = [
  // B2
  "Reported Speech â€” All Tenses & Advanced Structures",
  "Relative Clauses â€” Defining, Non-defining & Reduced",
  "Articles â€” The Zero Article, Generic Use & Advanced Cases",
  "Emphasis â€” Cleft Sentences, Inversion & It-Extraposition",
  "Future Forms â€” Will vs Going To vs Present Continuous vs Future Perfect",
  "Gerunds vs Infinitives â€” Advanced Distinctions & Meaning Differences",
  "Linking Words & Discourse Markers â€” Contrast, Concession, Addition",
  "Determiners & Quantifiers â€” Few/A Few, Little/A Little, Much/Many Advanced",
  // B2+
  "Wish, If Only & Regret Structures â€” Present, Past & Mixed",
  "Advanced Conditionals â€” Unless, Provided That, As Long As",
  "Nominalization â€” Turning Verbs & Adjectives into Nouns (Academic Style)",
  "The Subjunctive â€” Formal Uses in Modern English",
  "Fronting & Inversion for Emphasis â€” Negative Adverbials",
  "Complex Noun Phrases â€” Pre- and Post-modification",
  "Ellipsis & Substitution â€” Avoiding Repetition in Formal English",
  // C1
  "Advanced Modal Meanings â€” Tentativeness, Distancing, Hedging",
  "Stance Markers & Hedging Language â€” Academic Writing",
  "Complex Passive Structures â€” Double Passives, Pseudo-Passives",
  "Concord & Agreement â€” Advanced Subject-Verb Agreement Cases",
  "Register Shift â€” Formal, Informal & Academic Equivalents",
  "Cohesion & Coherence â€” Advanced Paragraph Linking",
  "Idiomatic Grammar â€” Fixed Expressions & Semi-fixed Structures"
];

const VOCAB_THEMES_POOL = [
  "UK idioms and expressions",
  "Advanced phrasal verbs (separable and inseparable)",
  "Academic collocations for essays and reports",
  "Words for describing personality and character",
  "Business and professional vocabulary",
  "Words related to change and transformation",
  "Formal synonyms for common words",
  "Words for cause and effect",
  "Abstract concepts in social and political discourse",
  "Words of manner and degree (adverbs and intensifiers)",
  "Vocabulary for describing trends and data",
  "Legal and institutional vocabulary",
  "Vocabulary for expressing certainty and doubt",
  "Words related to time and sequence",
  "Emotionally nuanced vocabulary",
  "False friends for French speakers",
  "Literary and cultural vocabulary",
  "Vocabulary for concession and contrast"
];

function getLevelForLesson(id) {
  return LEVEL_PROGRESSION.find(l => id >= l.min && id <= l.max) 
    || LEVEL_PROGRESSION[LEVEL_PROGRESSION.length - 1];
}

function getUsedWords() {
  const d = appData;
  return d.wordsLearned.map(w => w.word).join(', ');
}

function getUsedGrammar() {
  const d = appData;
  return d.grammarHistory.map(g => g.topic).join('; ');
}

function pickGrammarTopic(lessonId) {
  const used = appData.grammarHistory.map(g => g.topic);
  const available = GRAMMAR_TOPICS_POOL.filter(t => !used.includes(t));
  if (available.length === 0) return GRAMMAR_TOPICS_POOL[lessonId % GRAMMAR_TOPICS_POOL.length];
  // Pick based on lesson ID for some determinism
  return available[lessonId % available.length];
}

function pickVocabTheme(lessonId) {
  return VOCAB_THEMES_POOL[lessonId % VOCAB_THEMES_POOL.length];
}

function buildAIPrompt(lessonId) {
  const lvl = getLevelForLesson(lessonId);
  const grammarTopic = pickGrammarTopic(lessonId);
  const vocabTheme = pickVocabTheme(lessonId);
  const usedWords = getUsedWords();
  const usedGrammar = getUsedGrammar();

  return `You are generating lesson ${lessonId} for an English learning app targeting French speakers going from B1 to C1.

LEVEL: ${lvl.level}
MODULE: ${lvl.module}
VOCABULARY THEME: ${vocabTheme}
GRAMMAR TOPIC: ${grammarTopic}

ALREADY USED WORDS (do not repeat): ${usedWords || 'none yet'}
ALREADY USED GRAMMAR (do not repeat): ${usedGrammar || 'none yet'}

Generate a complete lesson as a single JSON object with this EXACT structure:
{
  "id": ${lessonId},
  "module": "${lvl.module}",
  "level": "${lvl.level}",
  "vocabulary": [
    {
      "word": "string",
      "phonetic": "/string/",
      "pos": "string",
      "definition": "Clear English definition (1-2 sentences)",
      "examples": ["Example sentence 1.", "Example sentence 2."],
      "collocations": ["collocation 1", "collocation 2", "collocation 3", "collocation 4"],
      "register": "string (e.g. formal, informal, academic, neutral, colloquial UK)",
      "frenchError": "Specific error French speakers make with this word + correction",
      "fr": "French translation / equivalents"
    }
  ],
  "grammar": {
    "topic": "${grammarTopic}",
    "level": "${lvl.level}",
    "explanation": "HTML string with h4 tags, formula divs (class='formula'), example spans (class='example-en'), warning divs (class='warning'), exception divs (class='exception'). Minimum 400 words. Include: rule explanation, when to use, examples, French speaker pitfalls, edge cases.",
    "exercises": [
      {
        "type": "Error Correction",
        "prompt": "Correct the error: ...",
        "answer": "correct answer string",
        "explanation": "brief explanation"
      },
      {
        "type": "Sentence Transformation",
        "prompt": "Transform: ...",
        "answer": "model answer",
        "explanation": "brief explanation"
      },
      {
        "type": "Advanced Gap Fill",
        "prompt": "Complete: ...",
        "answer": "answer",
        "explanation": "brief explanation"
      },
      {
        "type": "Translation from French",
        "prompt": "Translate: ...",
        "answer": "English translation",
        "explanation": "brief explanation"
      }
    ]
  }
}

REQUIREMENTS:
- Exactly 10 vocabulary words
- Words must be ${lvl.level} level appropriate â€” not too simple, not too advanced
- Mix word types: verbs, nouns, adjectives, adverbs, phrasal verbs
- Each frenchError must be SPECIFIC and useful (common actual mistake, not generic)
- Grammar explanation must be detailed and pedagogically complete
- Grammar exercises must be genuinely difficult for ${lvl.level}
- ALL 4 grammar exercises required
- No markdown â€” return ONLY the raw JSON object, nothing else`;
}

async function generateAILesson(lessonId) {
  const container = document.getElementById('lesson-container');
  const lvl = getLevelForLesson(lessonId);
  
  // Show loading UI
  container.innerHTML = `
    <div class="ai-loading">
      <div class="ai-loading-spinner"></div>
      <div class="ai-loading-title">Generating Lesson ${lessonId}</div>
      <div style="margin-bottom:16px;">
        <span class="ai-badge">âœ¦ AI-powered</span>
        <span style="margin-left:8px;font-size:12px;color:var(--text3)">${lvl.level} Â· ${lvl.module}</span>
      </div>
      <div class="ai-loading-steps" id="ai-status">Preparing your personalised lessonâ€¦</div>
    </div>
  `;

  const setStatus = (msg) => {
    const el = document.getElementById('ai-status');
    if (el) el.textContent = msg;
  };

  try {
    setStatus('Connecting to Claudeâ€¦');
    
    const prompt = buildAIPrompt(lessonId);
    
    setStatus('Generating vocabulary & grammarâ€¦');
    
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 4000,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error(err.error?.message || `HTTP ${response.status}`);
    }

    setStatus('Processing lesson dataâ€¦');
    
    const data = await response.json();
    const raw = data.content?.[0]?.text || '';
    
    // Extract JSON â€” strip any accidental markdown fences
    const cleaned = raw.replace(/```json|```/g, '').trim();
    
    // Find JSON object boundaries
    const start = cleaned.indexOf('{');
    const end = cleaned.lastIndexOf('}');
    if (start === -1 || end === -1) throw new Error('No JSON found in response');
    
    const jsonStr = cleaned.slice(start, end + 1);
    const lesson = JSON.parse(jsonStr);
    
    // Validate minimum structure
    if (!lesson.vocabulary || !Array.isArray(lesson.vocabulary) || lesson.vocabulary.length < 5) {
      throw new Error('Lesson data incomplete â€” vocabulary missing');
    }
    if (!lesson.grammar || !lesson.grammar.explanation) {
      throw new Error('Lesson data incomplete â€” grammar missing');
    }
    
    // Ensure IDs are correct
    lesson.id = lessonId;
    
    // Cache the lesson
    S.set('ai_lesson_' + lessonId, lesson);
    
    setStatus('Lesson ready!');
    
    // Load the lesson
    currentLesson = lesson;
    lessonPhase = 'vocab';
    currentWordIndex = 0;
    exerciseStates = {};
    grammarExerciseStates = {};
    
    // Small delay for UX
    await new Promise(r => setTimeout(r, 400));
    renderVocabPhase();
    
  } catch (err) {
    console.error('AI generation error:', err);
    container.innerHTML = `
      <div class="ai-error-box" style="margin:0">
        <div class="ai-error-title">âš  Generation Failed</div>
        <div class="ai-error-msg">
          Could not generate lesson ${lessonId}.<br>
          <strong>Error:</strong> ${err.message}<br><br>
          This feature requires the Claude API to be accessible from this page. 
          If you're running this locally, the browser may be blocking the API call.
          Try opening this file via a local server or deploy it online.
        </div>
      </div>
      <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="generateAILesson(${lessonId})">â†» Retry</button>
        <button class="btn btn-ghost" onclick="showView('vocab')">Vocabulary Bank</button>
        <button class="btn btn-ghost" onclick="showView('progress')">Progress</button>
      </div>
    `;
  }
}

// ============================================================
// START
// ============================================================
init();
</script>

</body>
</html>
